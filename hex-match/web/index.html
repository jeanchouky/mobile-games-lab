<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Hex Match</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{background:#0a0a1e;overflow:hidden;font-family:-apple-system,system-ui,sans-serif;color:#fff}
canvas{display:block;width:100vw;height:100vh}
#ui{position:absolute;top:0;left:0;width:100%;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:10;pointer-events:none}
#ui>*{pointer-events:auto}
.score-box{background:rgba(0,0,0,0.5);border-radius:12px;padding:8px 16px;backdrop-filter:blur(10px)}
.score-box .label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#888}
.score-box .val{font-size:24px;font-weight:900}
#menu{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(10,10,30,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20}
#menu h1{font-size:48px;margin-bottom:8px;background:linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
#menu p{color:#888;margin-bottom:30px;font-size:14px}
#menu button{background:linear-gradient(135deg,#ff6b6b,#ee5a24);border:none;color:#fff;padding:16px 40px;border-radius:50px;font-size:18px;font-weight:700;margin:8px;cursor:pointer;min-width:200px;transition:transform .15s}
#menu button:active{transform:scale(0.95)}
#menu button.zen{background:linear-gradient(135deg,#6bcb77,#1dd1a1)}
.hidden{display:none!important}
#timer-bar{position:absolute;top:60px;left:16px;right:16px;height:6px;border-radius:3px;background:rgba(255,255,255,0.1);z-index:10;overflow:hidden}
#timer-fill{height:100%;background:linear-gradient(90deg,#ff6b6b,#ffd93d);border-radius:3px;transition:width .1s linear}
#combo{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:60px;font-weight:900;pointer-events:none;z-index:10;opacity:0;text-shadow:0 0 30px rgba(255,107,107,0.8)}
#combo-mult{position:absolute;top:72px;left:50%;transform:translateX(-50%);font-size:20px;font-weight:900;color:#ffd93d;text-shadow:0 0 12px rgba(255,217,61,0.6);z-index:10;opacity:0;transition:opacity 0.3s;pointer-events:none}
#game-over{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(10,10,30,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20}
#game-over h2{font-size:36px;margin-bottom:8px}
#game-over .final{font-size:64px;font-weight:900;background:linear-gradient(135deg,#ffd93d,#ff6b6b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
#game-over button{background:linear-gradient(135deg,#4d96ff,#6bcb77);border:none;color:#fff;padding:14px 36px;border-radius:50px;font-size:16px;font-weight:700;margin-top:20px;cursor:pointer}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <div class="score-box"><div class="label">Score</div><div class="val" id="score">0</div></div>
  <div class="score-box"><div class="label">Best</div><div class="val" id="best">0</div></div>
</div>
<div id="timer-bar" class="hidden"><div id="timer-fill"></div></div>
<div id="combo"></div>
<div id="combo-mult"></div>
<div id="menu">
  <h1>‚¨° Hex Match</h1>
  <p>Match 3+ to score ‚Ä¢ Swipe to swap</p>
  <button onclick="startGame('timed')">‚è± Timed Mode</button>
  <button class="zen" onclick="startGame('zen')">üßò Zen Mode (‚àû)</button>
</div>
<div id="game-over" class="hidden">
  <h2>Game Over</h2>
  <div class="final" id="final-score">0</div>
  <p style="color:#888">High Score: <span id="final-best">0</span></p>
  <button onclick="backToMenu()">Play Again</button>
</div>

<script>
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H,dpr;
const COLORS=['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#a55eea','#fd79a8'];
const GLOW=['rgba(255,107,107,','rgba(255,217,61,','rgba(107,203,119,','rgba(77,150,255,','rgba(165,94,234,','rgba(253,121,168,'];

let grid=[],cols=7,rows=9,hexR,hexW,hexH,offX,offY;
let score=0,bestScore=0,mode='timed',timeLeft=60,maxTime=60,gameActive=false;
let selected=null,swapTarget=null,animating=false;
let particles=[],comboCount=0,shakeX=0,shakeY=0,shakeMag=0;
let touchStart=null,touchHex=null;

// Audio ‚Äî deferred to user gesture
let actx=null;
function getACtx(){if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)();actx.resume();return actx}
function playSound(freq,dur,type='sine',vol=0.15){
  try{const ctx=getACtx();const o=ctx.createOscillator(),g=ctx.createGain();
  o.type=type;o.frequency.value=freq;
  g.gain.setValueAtTime(vol,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
  o.connect(g);g.connect(ctx.destination);
  o.start();o.stop(ctx.currentTime+dur);}catch(e){}
}
function popSound(n){playSound(400+n*100,0.15,'sine',0.1);setTimeout(()=>playSound(600+n*100,0.1,'triangle',0.08),50)}
function comboSound(n){playSound(300+n*150,0.3,'sine',0.12);playSound(450+n*150,0.2,'triangle',0.08)}

function resize(){
  dpr=window.devicePixelRatio||1;
  W=window.innerWidth;H=window.innerHeight;
  C.width=W*dpr;C.height=H*dpr;
  C.style.width=W+'px';C.style.height=H+'px';
  X.setTransform(dpr,0,0,dpr,0,0);
  hexR=Math.min(W/(cols*2+1),((H-100)/(rows*1.8)))/1.1;
  hexW=hexR*Math.sqrt(3);hexH=hexR*2;
  offX=(W-cols*hexW)/2+hexW/2;
  offY=90+hexR;
}

function hexPos(c,r){
  let x=offX+c*hexW+(r%2?hexW/2:0);
  let y=offY+r*hexH*0.75;
  return{x,y};
}

function drawHex(cx,cy,r,fill,glow,alpha=1){
  X.save();X.globalAlpha=alpha;
  if(glow){
    X.shadowColor=glow;X.shadowBlur=15;
  }
  X.beginPath();
  for(let i=0;i<6;i++){
    let a=Math.PI/3*i-Math.PI/6;
    let px=cx+r*Math.cos(a),py=cy+r*Math.sin(a);
    i===0?X.moveTo(px,py):X.lineTo(px,py);
  }
  X.closePath();
  X.fillStyle=fill;X.fill();
  X.strokeStyle='rgba(255,255,255,0.1)';X.lineWidth=1;X.stroke();
  X.restore();
}

function initGrid(){
  grid=[];
  for(let r=0;r<rows;r++){
    grid[r]=[];
    for(let c=0;c<cols;c++){
      let color;
      do{color=Math.floor(Math.random()*COLORS.length)}
      while(hasMatchAt(c,r,color));
      grid[r][c]={color,scale:1,falling:0,power:false};
    }
  }
}

function hasMatchAt(c,r,color){
  // Check horizontal
  let cnt=1;
  for(let i=c-1;i>=0&&grid[r][i]&&grid[r][i].color===color;i--)cnt++;
  for(let i=c+1;i<cols&&grid[r][i]&&grid[r][i].color===color;i++)cnt++;
  if(cnt>=3)return true;
  return false;
}

function getNeighbors(c,r){
  const even=r%2===0;
  const dirs=even?
    [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1]]:
    [[-1,0],[1,0],[0,-1],[0,1],[1,-1],[1,1]];
  return dirs.map(([dc,dr])=>({c:c+dc,r:r+dr})).filter(({c,r})=>c>=0&&c<cols&&r>=0&&r<rows);
}

function findMatches(){
  let matched=new Set();
  // BFS flood-fill for groups of 3+
  let visited=new Set();
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(!grid[r][c]||visited.has(r*cols+c))continue;
      let color=grid[r][c].color;
      let group=[];
      let queue=[{c,r}];
      let seen=new Set();
      seen.add(r*cols+c);
      while(queue.length){
        let{c:cc,r:rr}=queue.shift();
        group.push({c:cc,r:rr});
        visited.add(rr*cols+cc);
        for(let n of getNeighbors(cc,rr)){
          let key=n.r*cols+n.c;
          if(!seen.has(key)&&grid[n.r]&&grid[n.r][n.c]&&grid[n.r][n.c].color===color){
            seen.add(key);queue.push(n);
          }
        }
      }
      if(group.length>=3){
        group.forEach(({c,r})=>matched.add(r*cols+c));
      }
    }
  }
  return matched;
}

function removeMatches(matched){
  let count=matched.size;
  if(count===0)return 0;
  matched.forEach(key=>{
    let r=Math.floor(key/cols),c=key%cols;
    let pos=hexPos(c,r);
    let col=COLORS[grid[r][c].color];
    for(let i=0;i<8;i++){
      let a=Math.random()*Math.PI*2,sp=2+Math.random()*3;
      particles.push({x:pos.x,y:pos.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,color:col,size:3+Math.random()*3});
    }
    grid[r][c]=null;
  });
  return count;
}

function dropGems(){
  let moved=false;
  for(let c=0;c<cols;c++){
    for(let r=rows-1;r>=0;r--){
      if(!grid[r][c]){
        for(let above=r-1;above>=0;above--){
          if(grid[above][c]){
            grid[r][c]=grid[above][c];
            grid[above][c]=null;
            grid[r][c].falling=1;
            moved=true;
            break;
          }
        }
      }
    }
    for(let r=0;r<rows;r++){
      if(!grid[r][c]){
        grid[r][c]={color:Math.floor(Math.random()*COLORS.length),scale:1,falling:1};
        moved=true;
      }
    }
  }
  return moved;
}

async function processMatches(){
  animating=true;
  comboCount=0;
  while(true){
    let matched=findMatches();
    if(matched.size===0)break;
    comboCount++;
    let count=removeMatches(matched);
    let pts=count*10*comboCount;
    score+=pts;
    if(mode==='timed')timeLeft=Math.min(maxTime,timeLeft+count*0.5);
    popSound(comboCount);
    if(comboCount>1){
      comboSound(comboCount);
      showCombo(comboCount);
      shakeMag=Math.min(comboCount*3,15);
    }
    document.getElementById('score').textContent=score;
    await delay(200);
    dropGems();
    await delay(250);
  }
  animating=false;
}

function showCombo(n){
  let el=document.getElementById('combo');
  el.textContent=`${n}x COMBO!`;
  el.style.opacity='1';el.style.transform='translate(-50%,-50%) scale(1.2)';
  el.style.color=COLORS[n%COLORS.length];
  setTimeout(()=>{el.style.opacity='0';el.style.transform='translate(-50%,-50%) scale(0.8)'},800);
}

function delay(ms){return new Promise(r=>setTimeout(r,ms))}

function pixelToHex(px,py){
  let best=null,bestD=Infinity;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      let p=hexPos(c,r);
      let d=Math.hypot(px-p.x,py-p.y);
      if(d<hexR*0.9&&d<bestD){bestD=d;best={c,r}}
    }
  }
  return best;
}

function isNeighbor(a,b){
  return getNeighbors(a.c,a.r).some(n=>n.c===b.c&&n.r===b.r);
}

async function trySwap(a,b){
  if(animating)return;
  if(!isNeighbor(a,b))return;
  // Swap
  let tmp=grid[a.r][a.c];grid[a.r][a.c]=grid[b.r][b.c];grid[b.r][b.c]=tmp;
  let matched=findMatches();
  if(matched.size===0){
    // Swap back
    tmp=grid[a.r][a.c];grid[a.r][a.c]=grid[b.r][b.c];grid[b.r][b.c]=tmp;
    playSound(200,0.15,'square',0.08);
    return;
  }
  playSound(500,0.1,'sine',0.1);
  await processMatches();
}

// Touch handling
C.addEventListener('touchstart',e=>{
  e.preventDefault();
  if(!gameActive||animating)return;
  actx.resume();
  let t=e.touches[0];
  touchStart={x:t.clientX,y:t.clientY};
  touchHex=pixelToHex(t.clientX,t.clientY);
  selected=touchHex;
});

C.addEventListener('touchmove',e=>{e.preventDefault()});

C.addEventListener('touchend',e=>{
  e.preventDefault();
  if(!gameActive||animating||!touchHex||!touchStart)return;
  let t=e.changedTouches[0];
  let dx=t.clientX-touchStart.x,dy=t.clientY-touchStart.y;
  let dist=Math.hypot(dx,dy);
  if(dist>20){
    // Find neighbor in swipe direction
    let angle=Math.atan2(dy,dx);
    let neighbors=getNeighbors(touchHex.c,touchHex.r);
    let bestN=null,bestDot=-Infinity;
    for(let n of neighbors){
      let np=hexPos(n.c,n.r),tp=hexPos(touchHex.c,touchHex.r);
      let ndx=np.x-tp.x,ndy=np.y-tp.y;
      let len=Math.hypot(ndx,ndy);
      let dot=Math.cos(angle)*(ndx/len)+Math.sin(angle)*(ndy/len);
      if(dot>bestDot){bestDot=dot;bestN=n}
    }
    if(bestN)trySwap(touchHex,bestN);
  }
  selected=null;touchStart=null;touchHex=null;
});

// Mouse fallback
let mouseDown=false;
C.addEventListener('mousedown',e=>{
  if(!gameActive||animating)return;
  actx.resume();
  mouseDown=true;
  touchStart={x:e.clientX,y:e.clientY};
  touchHex=pixelToHex(e.clientX,e.clientY);
  selected=touchHex;
});
C.addEventListener('mouseup',e=>{
  if(!mouseDown||!touchHex||!touchStart)return;
  mouseDown=false;
  let dx=e.clientX-touchStart.x,dy=e.clientY-touchStart.y;
  if(Math.hypot(dx,dy)>20){
    let angle=Math.atan2(dy,dx);
    let neighbors=getNeighbors(touchHex.c,touchHex.r);
    let bestN=null,bestDot=-Infinity;
    for(let n of neighbors){
      let np=hexPos(n.c,n.r),tp=hexPos(touchHex.c,touchHex.r);
      let ndx=np.x-tp.x,ndy=np.y-tp.y;
      let len=Math.hypot(ndx,ndy);
      let dot=Math.cos(angle)*(ndx/len)+Math.sin(angle)*(ndy/len);
      if(dot>bestDot){bestDot=dot;bestN=n}
    }
    if(bestN)trySwap(touchHex,bestN);
  }
  selected=null;touchStart=null;touchHex=null;
});

function render(){
  X.clearRect(0,0,W,H);
  // Shake
  if(shakeMag>0){
    shakeX=(Math.random()-0.5)*shakeMag;
    shakeY=(Math.random()-0.5)*shakeMag;
    shakeMag*=0.9;
    if(shakeMag<0.5)shakeMag=0;
  }else{shakeX=0;shakeY=0}
  
  X.save();X.translate(shakeX,shakeY);
  
  // Draw grid bg
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      let p=hexPos(c,r);
      drawHex(p.x,p.y,hexR*0.95,'rgba(255,255,255,0.03)',null);
    }
  }
  
  // Draw gems
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(!grid[r]||!grid[r][c])continue;
      let gem=grid[r][c];
      let p=hexPos(c,r);
      if(gem.falling>0){gem.falling=Math.max(0,gem.falling-0.08)}
      let s=selected&&selected.c===c&&selected.r===r?1.15:1;
      let glowCol=GLOW[gem.color]+'0.4)';
      drawHex(p.x,p.y,hexR*0.8*s,COLORS[gem.color],glowCol);
      // Inner highlight
      X.save();X.globalAlpha=0.3;
      drawHex(p.x-hexR*0.1,p.y-hexR*0.15,hexR*0.35,'rgba(255,255,255,0.5)',null);
      X.restore();
    }
  }
  
  // Particles
  for(let i=particles.length-1;i>=0;i--){
    let p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life-=0.025;
    if(p.life<=0){particles.splice(i,1);continue}
    X.globalAlpha=p.life;
    X.fillStyle=p.color;
    X.beginPath();X.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);X.fill();
    X.globalAlpha=1;
  }
  
  X.restore();
  
  // Timer
  if(mode==='timed'&&gameActive){
    document.getElementById('timer-fill').style.width=(timeLeft/maxTime*100)+'%';
  }
  
  requestAnimationFrame(render);
}

let lastTime=0;
function gameLoop(t){
  if(!lastTime)lastTime=t;
  let dt=(t-lastTime)/1000;
  lastTime=t;
  
  if(gameActive&&mode==='timed'){
    timeLeft-=dt;
    if(timeLeft<=0){
      timeLeft=0;gameActive=false;
      endGame();
    }
  }
  requestAnimationFrame(gameLoop);
}

function endGame(){
  if(score>bestScore){bestScore=score;localStorage.setItem('hexmatch_best',bestScore)}
  document.getElementById('final-score').textContent=score;
  document.getElementById('final-best').textContent=bestScore;
  document.getElementById('game-over').classList.remove('hidden');
  // Victory sound
  playSound(523,0.15,'sine',0.1);setTimeout(()=>playSound(659,0.15,'sine',0.1),100);setTimeout(()=>playSound(784,0.2,'sine',0.1),200);
}

function startGame(m){
  actx.resume();
  mode=m;score=0;timeLeft=maxTime;comboCount=0;
  document.getElementById('score').textContent='0';
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('game-over').classList.add('hidden');
  if(mode==='timed'){
    document.getElementById('timer-bar').classList.remove('hidden');
  }else{
    document.getElementById('timer-bar').classList.add('hidden');
  }
  initGrid();
  // Clear initial matches
  (async()=>{await processMatches();gameActive=true})();
}

function backToMenu(){
  document.getElementById('game-over').classList.add('hidden');
  document.getElementById('menu').classList.remove('hidden');
}

window.addEventListener('resize',resize);
bestScore=parseInt(localStorage.getItem('hexmatch_best'))||0;
document.getElementById('best').textContent=bestScore;
resize();
render();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
