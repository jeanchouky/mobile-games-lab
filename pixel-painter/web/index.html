<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Pixel Painter</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a2e">
<meta name="description" content="Create pixel art with layers, PNG export, undo/redo, and color picker">
<meta property="og:title" content="Pixel Painter ‚Äî Mobile Games Lab">
<meta property="og:description" content="Pixel art creator with layers, export, and full color tools">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pixel Painter">
<meta name="twitter:description" content="Browser-based pixel art creator with layers and export">
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
body{background:#1a1a2e;overflow:hidden;font-family:-apple-system,system-ui,sans-serif;color:#fff;display:flex;flex-direction:column;height:100vh;touch-action:none}
#toolbar{display:flex;align-items:center;padding:8px;gap:6px;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);z-index:10;flex-wrap:wrap}
#toolbar button{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 12px;border-radius:8px;font-size:14px;cursor:pointer;min-width:36px}
#toolbar button.active{background:rgba(255,217,61,0.2);border-color:#ffd93d}
#toolbar button:active{transform:scale(0.95)}
#size-display{font-size:11px;color:#888;margin-left:auto}
canvas{flex:1;display:block;background:#16213e}
#palette{display:flex;padding:6px;gap:4px;background:rgba(0,0,0,0.4);flex-wrap:wrap;justify-content:center}
.swatch{width:32px;height:32px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .1s}
.swatch.active{border-color:#fff;transform:scale(1.15);box-shadow:0 0 10px rgba(255,255,255,0.3)}
#bottom-bar{display:flex;padding:8px;gap:6px;background:rgba(0,0,0,0.4);justify-content:center}
#bottom-bar button{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer}
#bottom-bar button:active{transform:scale(0.95)}
#gallery{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.97);z-index:20;overflow-y:auto;padding:16px}
#gallery h2{text-align:center;margin-bottom:16px}
#gallery .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
#gallery .gallery-item{aspect-ratio:1;background:#16213e;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid rgba(255,255,255,0.1)}
#gallery .gallery-item img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
#gallery .close-btn{position:fixed;top:16px;right:16px;background:rgba(255,255,255,0.1);border:none;color:#fff;width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer}
.hidden{display:none!important}
#prompt-bar{text-align:center;padding:6px;background:rgba(255,217,61,0.1);font-size:12px;color:#ffd93d}
#hex-input-wrap{display:flex;align-items:center;gap:4px;margin-left:4px}
#hex-input{width:72px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-family:monospace;font-size:13px;padding:6px 8px;border-radius:6px;text-transform:uppercase}
#hex-preview{width:28px;height:28px;border-radius:6px;border:2px solid rgba(255,255,255,0.3)}
#layer-panel{display:flex;flex-direction:column;gap:2px;padding:6px;background:rgba(0,0,0,0.5);max-height:140px;overflow-y:auto}
#layer-panel .layer-row{display:flex;align-items:center;gap:4px;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:12px;background:rgba(255,255,255,0.04)}
#layer-panel .layer-row.active{background:rgba(255,217,61,0.15);border:1px solid rgba(255,217,61,0.3)}
#layer-panel .layer-row .vis-btn{background:none;border:none;color:#fff;font-size:14px;cursor:pointer;padding:0 2px;opacity:0.7}
#layer-panel .layer-row .vis-btn:hover{opacity:1}
#layer-panel .layer-row .layer-name{flex:1;color:#ccc;font-size:11px}
#layer-panel .layer-row.active .layer-name{color:#ffd93d}
#layer-panel .layer-row .opacity-slider{width:50px;height:4px;accent-color:#ffd93d}
#layer-controls{display:flex;gap:4px;padding:4px 6px;background:rgba(0,0,0,0.4);justify-content:center}
#layer-controls button{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer}
#layer-controls button:active{transform:scale(0.95)}
</style>
</head>
<body>
<div id="prompt-bar">‚úèÔ∏è Daily Prompt: <span id="daily-prompt">Loading...</span></div>
<div id="toolbar">
  <button id="btn-draw" class="active" onclick="setTool('draw')">‚úèÔ∏è</button>
  <button id="btn-erase" onclick="setTool('erase')">üßπ</button>
  <button id="btn-fill" onclick="setTool('fill')">ü™£</button>
  <button id="btn-pick" onclick="setTool('pick')">üíâ</button>
  <button id="btn-mirror" onclick="toggleMirror()">ü™û</button>
  <button id="btn-undo" onclick="undo()">‚Ü©Ô∏è</button>
  <button id="btn-redo" onclick="redo()">‚Ü™Ô∏è</button>
  <button onclick="clearCanvas()">üóëÔ∏è</button>
  <span id="size-display">16√ó16</span>
</div>
<canvas id="c"></canvas>
<div id="palette">
  <div id="hex-input-wrap">
    <div id="hex-preview"></div>
    <input type="text" id="hex-input" maxlength="7" placeholder="#FF6B6B" spellcheck="false">
  </div>
</div>
<div id="layer-controls">
  <button onclick="addLayer()">+ Layer</button>
  <button onclick="deleteLayer()">üóëÔ∏è</button>
  <button onclick="moveLayer(-1)">‚ñ≤</button>
  <button onclick="moveLayer(1)">‚ñº</button>
  <button onclick="mergeDown()">‚§µ Merge</button>
</div>
<div id="layer-panel"></div>
<div id="bottom-bar">
  <button onclick="changeSize(-4)">‚ûñ Size</button>
  <button onclick="changeSize(4)">‚ûï Size</button>
  <button onclick="saveToGallery()">üíæ Save</button>
  <button onclick="showGallery()">üñºÔ∏è Gallery</button>
  <button onclick="exportPNG()">üì• Export PNG</button>
</div>
<div id="gallery" class="hidden">
  <button class="close-btn" onclick="hideGallery()">‚úï</button>
  <h2>üñºÔ∏è Gallery</h2>
  <div class="gallery-grid" id="gallery-grid"></div>
</div>

<script>
const C=document.getElementById('c'),X=C.getContext('2d');
const COLORS=[
  '#000000','#ffffff','#ff6b6b','#e94560','#c23152','#a55eea','#6c5ce7',
  '#4d96ff','#74b9ff','#0abde3','#1dd1a1','#6bcb77','#badc58','#ffd93d',
  '#fdcb6e','#e17055','#d63031','#b33939','#6d4c41','#8d6e63',
  '#bdbdbd','#757575','#424242','#2d3436','#636e72','#dfe6e9',
  '#fab1a0','#ffeaa7','#55efc4','#81ecec','#a29bfe','#fd79a8'
];

let gridSize=16,tool='draw',currentColor='#ff6b6b';
let layers=[],activeLayerIdx=0;
let history=[],historyIdx=-1,maxHistory=50;
let cellPx,offX,offY,drawing=false;
let mirrorMode=false;

function toggleMirror(){
  mirrorMode=!mirrorMode;
  document.getElementById('btn-mirror').classList.toggle('active',mirrorMode);
}

const PROMPTS=['a sunset','your pet','a robot','a tree','a spaceship','a castle','a dragon','pizza','a ghost','the ocean','a mountain','a flower','a cat face','a mushroom','a sword','rainy day','a star','your mood','a burger','the moon','a house','a bird','a fish','a heart','a skull','fire','ice cream','a rainbow','a crown','lightning'];

function makePixels(){
  let p=[];
  for(let y=0;y<gridSize;y++){p[y]=[];for(let x=0;x<gridSize;x++)p[y][x]=null}
  return p;
}
function makeLayer(name){return{name,pixels:makePixels(),visible:true,opacity:1}}
function initLayers(){
  layers=[makeLayer('Layer 1')];
  activeLayerIdx=0;
  history=[];historyIdx=-1;
  pushHistory();
  renderLayerPanel();
}
function getPixels(){return layers[activeLayerIdx].pixels}

function pushHistory(){
  history=history.slice(0,historyIdx+1);
  const snap=layers.map(l=>({name:l.name,pixels:JSON.parse(JSON.stringify(l.pixels)),visible:l.visible,opacity:l.opacity}));
  history.push({layers:snap,activeLayerIdx});
  if(history.length>maxHistory)history.shift();
  historyIdx=history.length-1;
}

function undo(){
  if(historyIdx>0){
    historyIdx--;
    const snap=history[historyIdx];
    layers=snap.layers.map(l=>({name:l.name,pixels:JSON.parse(JSON.stringify(l.pixels)),visible:l.visible,opacity:l.opacity}));
    activeLayerIdx=snap.activeLayerIdx;
    renderLayerPanel();
  }
}
function redo(){
  if(historyIdx<history.length-1){
    historyIdx++;
    const snap=history[historyIdx];
    layers=snap.layers.map(l=>({name:l.name,pixels:JSON.parse(JSON.stringify(l.pixels)),visible:l.visible,opacity:l.opacity}));
    activeLayerIdx=snap.activeLayerIdx;
    renderLayerPanel();
  }
}

function resize(){
  let dpr=window.devicePixelRatio||1;
  let w=window.innerWidth;
  let toolbarH=document.getElementById('toolbar').offsetHeight;
  let paletteH=document.getElementById('palette').offsetHeight;
  let bottomH=document.getElementById('bottom-bar').offsetHeight;
  let promptH=document.getElementById('prompt-bar').offsetHeight;
  let layerH=document.getElementById('layer-panel').offsetHeight+(document.getElementById('layer-controls').offsetHeight||0);
  let h=window.innerHeight-toolbarH-paletteH-bottomH-promptH-layerH;
  C.width=w*dpr;C.height=h*dpr;
  C.style.width=w+'px';C.style.height=h+'px';
  X.setTransform(dpr,0,0,dpr,0,0);
  cellPx=Math.floor(Math.min(w,h)*0.9/gridSize);
  offX=(w-gridSize*cellPx)/2;
  offY=(h-gridSize*cellPx)/2;
}

function render(){
  let w=C.width/(window.devicePixelRatio||1);
  let h=C.height/(window.devicePixelRatio||1);
  X.fillStyle='#16213e';X.fillRect(0,0,w,h);

  // Checkerboard for transparency
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      let px=offX+x*cellPx,py=offY+y*cellPx;
      X.fillStyle=(x+y)%2===0?'rgba(255,255,255,0.03)':'rgba(255,255,255,0.06)';
      X.fillRect(px,py,cellPx,cellPx);
    }
  }

  // Composite visible layers bottom to top
  for(let li=layers.length-1;li>=0;li--){
    const layer=layers[li];
    if(!layer.visible)continue;
    X.globalAlpha=layer.opacity;
    for(let y=0;y<gridSize;y++){
      for(let x=0;x<gridSize;x++){
        if(layer.pixels[y]&&layer.pixels[y][x]){
          X.fillStyle=layer.pixels[y][x];
          X.fillRect(offX+x*cellPx,offY+y*cellPx,cellPx,cellPx);
        }
      }
    }
  }
  X.globalAlpha=1;

  // Active layer highlight border
  const al=layers[activeLayerIdx];
  if(al){
    for(let y=0;y<gridSize;y++){
      for(let x=0;x<gridSize;x++){
        if(al.pixels[y]&&al.pixels[y][x]){
          X.strokeStyle='rgba(255,217,61,0.15)';X.lineWidth=0.5;
          X.strokeRect(offX+x*cellPx,offY+y*cellPx,cellPx,cellPx);
        }
      }
    }
  }

  // Grid lines
  X.strokeStyle='rgba(255,255,255,0.08)';X.lineWidth=0.5;
  for(let i=0;i<=gridSize;i++){
    X.beginPath();X.moveTo(offX+i*cellPx,offY);X.lineTo(offX+i*cellPx,offY+gridSize*cellPx);X.stroke();
    X.beginPath();X.moveTo(offX,offY+i*cellPx);X.lineTo(offX+gridSize*cellPx,offY+i*cellPx);X.stroke();
  }

  requestAnimationFrame(render);
}

function getCellFromEvent(e){
  let rect=C.getBoundingClientRect();
  let px=(e.clientX||e.touches[0].clientX)-rect.left;
  let py=(e.clientY||e.touches[0].clientY)-rect.top;
  let x=Math.floor((px-offX)/cellPx);
  let y=Math.floor((py-offY)/cellPx);
  if(x<0||x>=gridSize||y<0||y>=gridSize)return null;
  return{x,y};
}

function paint(cell){
  if(!cell)return;
  const px=getPixels();
  if(tool==='pick'){
    // Pick from composited view (check all visible layers top to bottom)
    for(let li=0;li<layers.length;li++){
      if(layers[li].visible&&layers[li].pixels[cell.y][cell.x]){
        currentColor=layers[li].pixels[cell.y][cell.x];
        updateColorUI();
        tool='draw';setTool('draw');
        return;
      }
    }
    return;
  }
  if(tool==='draw'){
    px[cell.y][cell.x]=currentColor;
    if(mirrorMode)px[cell.y][gridSize-1-cell.x]=currentColor;
  }
  else if(tool==='erase'){
    px[cell.y][cell.x]=null;
    if(mirrorMode)px[cell.y][gridSize-1-cell.x]=null;
  }
  else if(tool==='fill'){floodFill(cell.x,cell.y,px[cell.y][cell.x],currentColor)}
}

function floodFill(x,y,target,fill){
  if(target===fill)return;
  const px=getPixels();
  let stack=[{x,y}];
  let visited=new Set();
  while(stack.length){
    let{x:cx,y:cy}=stack.pop();
    if(cx<0||cx>=gridSize||cy<0||cy>=gridSize)continue;
    let key=cy*gridSize+cx;
    if(visited.has(key))continue;
    visited.add(key);
    if(px[cy][cx]!==target)continue;
    px[cy][cx]=fill;
    stack.push({x:cx+1,y:cy},{x:cx-1,y:cy},{x:cx,y:cy+1},{x:cx,y:cy-1});
  }
}

C.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;let c=getCellFromEvent(e);paint(c)});
C.addEventListener('touchmove',e=>{e.preventDefault();if(drawing){let c=getCellFromEvent(e);paint(c)}});
C.addEventListener('touchend',e=>{e.preventDefault();if(drawing){drawing=false;pushHistory()}});
C.addEventListener('mousedown',e=>{drawing=true;paint(getCellFromEvent(e))});
C.addEventListener('mousemove',e=>{if(drawing)paint(getCellFromEvent(e))});
C.addEventListener('mouseup',()=>{if(drawing){drawing=false;pushHistory()}});

function setTool(t){
  tool=t;
  document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+t)?.classList.add('active');
}

function clearCanvas(){
  if(!confirm('Clear active layer? This can be undone with ‚Ü©Ô∏è'))return;
  const px=getPixels();
  for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++)px[y][x]=null;
  pushHistory();
}

function changeSize(d){
  gridSize=Math.max(8,Math.min(64,gridSize+d));
  document.getElementById('size-display').textContent=`${gridSize}√ó${gridSize}`;
  initLayers();resize();
}

function compositeLayers(tx,scale=1){
  for(let li=layers.length-1;li>=0;li--){
    const layer=layers[li];
    if(!layer.visible)continue;
    tx.globalAlpha=layer.opacity;
    for(let y=0;y<gridSize;y++){
      for(let x=0;x<gridSize;x++){
        if(layer.pixels[y]&&layer.pixels[y][x]){
          tx.fillStyle=layer.pixels[y][x];
          tx.fillRect(x*scale,y*scale,scale,scale);
        }
      }
    }
  }
  tx.globalAlpha=1;
}

function toDataURL(){
  let tc=document.createElement('canvas');
  tc.width=gridSize;tc.height=gridSize;
  let tx=tc.getContext('2d');
  compositeLayers(tx,1);
  return tc.toDataURL();
}

function saveToGallery(){
  let gallery=JSON.parse(localStorage.getItem('pixelpainter_gallery')||'[]');
  gallery.unshift({data:toDataURL(),date:Date.now(),size:gridSize});
  if(gallery.length>50)gallery.pop();
  localStorage.setItem('pixelpainter_gallery',JSON.stringify(gallery));
  // Flash feedback
  document.body.style.background='#2a2a4e';
  setTimeout(()=>document.body.style.background='#1a1a2e',200);
}

function showGallery(){
  let gallery=JSON.parse(localStorage.getItem('pixelpainter_gallery')||'[]');
  let grid=document.getElementById('gallery-grid');
  grid.innerHTML='';
  if(gallery.length===0){grid.innerHTML='<p style="color:#888;text-align:center;grid-column:1/-1">No saved art yet!</p>'}
  gallery.forEach((item,i)=>{
    let div=document.createElement('div');div.className='gallery-item';
    let img=document.createElement('img');img.src=item.data;
    div.appendChild(img);
    div.onclick=()=>{
      if(confirm('Load this artwork?')){
        let tc=document.createElement('canvas');tc.width=item.size;tc.height=item.size;
        // Load back... simplified: just show
        hideGallery();
      }
    };
    grid.appendChild(div);
  });
  document.getElementById('gallery').classList.remove('hidden');
}

function hideGallery(){document.getElementById('gallery').classList.add('hidden')}

function exportPNG(){
  let tc=document.createElement('canvas');
  const scale=Math.max(4,Math.floor(512/gridSize));
  tc.width=gridSize*scale;tc.height=gridSize*scale;
  let tx=tc.getContext('2d');
  tx.fillStyle='#16213e';tx.fillRect(0,0,tc.width,tc.height);
  compositeLayers(tx,scale);
  let a=document.createElement('a');a.href=tc.toDataURL();a.download='pixel-art.png';a.click();
}

// Layer management
function addLayer(){
  layers.unshift(makeLayer('Layer '+(layers.length+1)));
  activeLayerIdx=0;
  pushHistory();renderLayerPanel();
}
function deleteLayer(){
  if(layers.length<=1)return;
  layers.splice(activeLayerIdx,1);
  activeLayerIdx=Math.min(activeLayerIdx,layers.length-1);
  pushHistory();renderLayerPanel();
}
function moveLayer(dir){
  const ni=activeLayerIdx+dir;
  if(ni<0||ni>=layers.length)return;
  [layers[activeLayerIdx],layers[ni]]=[layers[ni],layers[activeLayerIdx]];
  activeLayerIdx=ni;
  pushHistory();renderLayerPanel();
}
function mergeDown(){
  if(activeLayerIdx>=layers.length-1)return;
  const src=layers[activeLayerIdx],dst=layers[activeLayerIdx+1];
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      if(src.pixels[y]&&src.pixels[y][x])dst.pixels[y][x]=src.pixels[y][x];
    }
  }
  layers.splice(activeLayerIdx,1);
  pushHistory();renderLayerPanel();
}
function setActiveLayer(idx){activeLayerIdx=idx;renderLayerPanel()}
function toggleLayerVisibility(idx){
  layers[idx].visible=!layers[idx].visible;
  renderLayerPanel();
}
function setLayerOpacity(idx,val){layers[idx].opacity=val;renderLayerPanel()}

function renderLayerPanel(){
  const panel=document.getElementById('layer-panel');
  panel.innerHTML='';
  layers.forEach((l,i)=>{
    const row=document.createElement('div');
    row.className='layer-row'+(i===activeLayerIdx?' active':'');
    row.innerHTML=`<button class="vis-btn" data-i="${i}">${l.visible?'üëÅÔ∏è':'üö´'}</button>`+
      `<span class="layer-name">${l.name}</span>`+
      `<input type="range" class="opacity-slider" min="0" max="100" value="${Math.round(l.opacity*100)}" data-i="${i}">`;
    row.addEventListener('click',e=>{
      if(e.target.tagName==='BUTTON'||e.target.tagName==='INPUT')return;
      setActiveLayer(i);
    });
    row.querySelector('.vis-btn').addEventListener('click',()=>toggleLayerVisibility(i));
    row.querySelector('.opacity-slider').addEventListener('input',e=>setLayerOpacity(i,e.target.value/100));
    panel.appendChild(row);
  });
}

// Hex color input
function updateColorUI(){
  document.getElementById('hex-input').value=currentColor;
  document.getElementById('hex-preview').style.background=currentColor;
  document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.swatch').forEach(s=>{
    if(s.style.backgroundColor&&rgbToHex(s.style.backgroundColor)===currentColor.toLowerCase())s.classList.add('active');
  });
}
function rgbToHex(rgb){
  if(rgb.startsWith('#'))return rgb.toLowerCase();
  const m=rgb.match(/\d+/g);
  if(!m||m.length<3)return rgb;
  return'#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join('');
}
document.getElementById('hex-input').addEventListener('input',e=>{
  let v=e.target.value.trim();
  if(!v.startsWith('#'))v='#'+v;
  if(/^#[0-9a-fA-F]{6}$/.test(v)){
    currentColor=v;
    document.getElementById('hex-preview').style.background=v;
    document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
    tool='draw';setTool('draw');
  }
});
document.getElementById('hex-input').addEventListener('keydown',e=>{if(e.key==='Enter')e.target.blur()});

// Build palette
let pal=document.getElementById('palette');
COLORS.forEach(c=>{
  let d=document.createElement('div');d.className='swatch';
  if(c===currentColor)d.classList.add('active');
  d.style.background=c;
  d.onclick=()=>{
    currentColor=c;tool='draw';setTool('draw');
    document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
    d.classList.add('active');
    updateColorUI();
  };
  pal.appendChild(d);
});

// Daily prompt
let day=Math.floor(Date.now()/86400000);
document.getElementById('daily-prompt').textContent=PROMPTS[day%PROMPTS.length];

initLayers();
window.addEventListener('resize',resize);
resize();
render();
updateColorUI();
</script>
</body>
</html>
