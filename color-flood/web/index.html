<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Color Flood</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a1a2e;font-family:-apple-system,system-ui,sans-serif;touch-action:none;user-select:none;display:flex;flex-direction:column;align-items:center;justify-content:center}
#game{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:500px;padding:16px}
#header{display:flex;justify-content:space-between;width:100%;padding:0 4px;color:#fff}
.stat{text-align:center}
.stat .val{font-size:1.5rem;font-weight:900;transition:transform 0.15s}
.stat .val.bump{transform:scale(1.2)}
.stat .lbl{font-size:0.7rem;color:#888;text-transform:uppercase;letter-spacing:1px}
#board-wrap{position:relative;width:min(90vw,90vh - 200px);height:min(90vw,90vh - 200px);max-width:460px;max-height:460px}
canvas{width:100%;height:100%;border-radius:12px;image-rendering:pixelated}
#colors{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:8px}
.color-btn{width:48px;height:48px;border-radius:50%;border:3px solid transparent;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.color-btn:hover{transform:scale(1.1)}
.color-btn:active{transform:scale(0.9)}
.color-btn.current{border-color:#fff;transform:scale(1.15);box-shadow:0 0 15px rgba(255,255,255,0.3)}
.color-btn.disabled{opacity:0.3;pointer-events:none}
#message{color:#fff;font-size:1.2rem;font-weight:700;min-height:1.5em;text-align:center;transition:opacity 0.3s}
#move-diff{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2rem;font-weight:900;pointer-events:none;z-index:20;opacity:0;transition:all 0.4s}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(26,26,46,0.95);z-index:10}
.overlay h1{font-size:clamp(2.5rem,8vw,4rem);font-weight:900;margin-bottom:8px}
.overlay h1 span{display:inline-block}
.overlay .sub{color:#888;margin-bottom:24px;font-size:0.9rem}
.overlay .result{color:#fff;font-size:1.5rem;font-weight:700;margin:8px 0}
.btn{background:linear-gradient(135deg,#e94560,#7b2ff7);border:none;color:#fff;font-weight:800;font-size:1rem;padding:14px 36px;border-radius:50px;cursor:pointer;margin:6px;letter-spacing:1px;transition:transform 0.15s}
.btn:active{transform:scale(0.95)}
.btn.secondary{background:rgba(255,255,255,0.1)}
.size-btns{display:flex;gap:8px;margin:16px 0}
.size-btn{padding:10px 20px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:none;color:#fff;font-weight:700;cursor:pointer;font-size:0.9rem;transition:all 0.15s}
.size-btn.active{border-color:#e94560;background:rgba(233,69,96,0.15)}
.size-btn:active{transform:scale(0.95)}
.hidden{display:none!important}
.stars{color:#ffd700;font-size:1.8rem;margin:8px 0}
#undo-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:700}
#undo-btn:disabled{opacity:0.3;cursor:default}
</style>
</head>
<body>

<div id="game" class="hidden">
  <div id="header">
    <div class="stat"><div class="val" id="moves">0</div><div class="lbl">Moves</div></div>
    <div class="stat"><div class="val" id="remaining">25</div><div class="lbl">Left</div></div>
    <div class="stat"><div class="val" id="pct">0%</div><div class="lbl">Captured</div></div>
    <div class="stat"><div class="val" id="best">-</div><div class="lbl">Best</div></div>
  </div>
  <div id="board-wrap"><canvas id="c"></canvas></div>
  <div id="colors"></div>
  <div style="display:flex;gap:12px;align-items:center;justify-content:center">
    <button id="undo-btn" onclick="undoMove()" disabled>â†© Undo</button>
    <div id="message"></div>
  </div>
</div>
<div id="move-diff"></div>

<div class="overlay" id="menu">
  <h1><span style="color:#e94560">C</span><span style="color:#ffd700">o</span><span style="color:#00f5d4">l</span><span style="color:#7b2ff7">o</span><span style="color:#ff6b6b">r</span> <span style="color:#4ecdc4">F</span><span style="color:#f7dc6f">l</span><span style="color:#a29bfe">o</span><span style="color:#fd79a8">o</span><span style="color:#6c5ce7">d</span></h1>
  <div class="sub">Flood the board with a single color</div>
  <div style="color:#aaa;font-size:0.8rem;margin-bottom:8px">Board Size</div>
  <div class="size-btns">
    <button class="size-btn" data-size="10">10Ã—10<br><span style="font-size:0.7rem;color:#888">Easy</span></button>
    <button class="size-btn active" data-size="14">14Ã—14<br><span style="font-size:0.7rem;color:#888">Medium</span></button>
    <button class="size-btn" data-size="18">18Ã—18<br><span style="font-size:0.7rem;color:#888">Hard</span></button>
  </div>
  <button class="btn" onclick="startGame()">PLAY</button>
</div>

<div class="overlay hidden" id="win-screen">
  <div class="result" id="win-text">ðŸŽ‰ Board Cleared!</div>
  <div class="stars" id="win-stars">â˜…â˜…â˜…</div>
  <div class="sub" id="win-detail"></div>
  <button class="btn" onclick="startGame()">PLAY AGAIN</button>
  <button class="btn secondary" onclick="showMenu()">MENU</button>
</div>

<script>
const PALETTES=[
  ['#e94560','#ffd700','#00f5d4','#7b2ff7','#ff6b6b','#4ecdc4'],
  ['#ff6348','#ffa502','#2ed573','#1e90ff','#a55eea','#ff4757'],
  ['#fd79a8','#fdcb6e','#00cec9','#6c5ce7','#e17055','#00b894'],
];
const PAR={10:18,14:25,18:32};

let boardSize=14,board,colors,moves,totalCells,captured,canvas,ctx,cellSize;
let audioCtx;
let history=[];
let animCells=new Map(); // cell key -> {progress}
let animRunning=false;

function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)()}
function playTone(f,d=0.08,v=0.1){
  if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(v,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);
}

function showMenu(){
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('game').classList.add('hidden');
  document.getElementById('win-screen').classList.add('hidden');
}

document.querySelectorAll('.size-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.size-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');boardSize=parseInt(b.dataset.size);
  });
});

function startGame(){
  initAudio();
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('win-screen').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');
  
  colors=PALETTES[Math.floor(Math.random()*PALETTES.length)];
  totalCells=boardSize*boardSize;
  board=[];moves=0;history=[];animCells.clear();
  
  for(let y=0;y<boardSize;y++){
    board[y]=[];
    for(let x=0;x<boardSize;x++)board[y][x]=Math.floor(Math.random()*colors.length);
  }
  
  canvas=document.getElementById('c');ctx=canvas.getContext('2d');
  canvas.width=canvas.height=boardSize*20;
  cellSize=20;
  
  const colDiv=document.getElementById('colors');
  colDiv.innerHTML='';
  colors.forEach((c,i)=>{
    const btn=document.createElement('div');
    btn.className='color-btn';btn.style.background=c;
    btn.addEventListener('click',()=>makeMove(i));
    colDiv.appendChild(btn);
  });
  
  updateCaptured();updateUI();drawBoard();
  const hs=localStorage.getItem(`colorflood_${boardSize}`);
  document.getElementById('best').textContent=hs||'-';
  document.getElementById('undo-btn').disabled=true;
}

function getConnected(color,startBoard){
  const b=startBoard||board;
  const visited=Array.from({length:boardSize},()=>Array(boardSize).fill(false));
  const q=[{x:0,y:0}];visited[0][0]=true;
  const result=[];
  while(q.length){
    const{x,y}=q.shift();
    result.push({x,y});
    for(const[dx,dy]of[[0,1],[0,-1],[1,0],[-1,0]]){
      const nx=x+dx,ny=y+dy;
      if(nx>=0&&nx<boardSize&&ny>=0&&ny<boardSize&&!visited[ny][nx]&&b[ny][nx]===color){
        visited[ny][nx]=true;q.push({x:nx,y:ny});
      }
    }
  }
  return result;
}

function makeMove(colorIdx){
  const currentColor=board[0][0];
  if(colorIdx===currentColor)return;
  
  // Save history for undo
  history.push(board.map(r=>[...r]));
  if(history.length>20)history.shift();
  document.getElementById('undo-btn').disabled=false;
  
  moves++;
  const region=getConnected(currentColor);
  
  // Animate the flood: find border cells that will be absorbed
  const regionSet=new Set(region.map(p=>p.x+','+p.y));
  const newCells=[];
  
  region.forEach(p=>board[p.y][p.x]=colorIdx);
  let newRegion=getConnected(colorIdx);
  
  // Find cells that are new to the region
  newRegion.forEach(p=>{
    const key=p.x+','+p.y;
    if(!regionSet.has(key)){
      newCells.push(p);
      animCells.set(key,{progress:0});
    }
  });
  
  captured=newRegion.length;
  const oldPct=Math.round((region.length)/totalCells*100);
  const newPct=Math.round(captured/totalCells*100);
  
  // Sound pitch based on capture %
  playTone(250+captured/totalCells*500,0.12);
  if(newCells.length>3)playTone(400+newCells.length*20,0.08,0.06);
  
  // Show big capture feedback
  if(newCells.length>=5){
    const el=document.getElementById('move-diff');
    el.textContent=`+${newCells.length} cells!`;
    el.style.color=colors[colorIdx];
    el.style.opacity='1';el.style.transform='translate(-50%,-50%) scale(1.2)';
    setTimeout(()=>{el.style.opacity='0';el.style.transform='translate(-50%,-50%) scale(0.8)'},800);
  }
  
  updateUI();drawBoard();
  
  if(captured===totalCells){
    setTimeout(()=>winGame(),300);
  }
}

function undoMove(){
  if(!history.length)return;
  board=history.pop();
  moves=Math.max(0,moves-1);
  animCells.clear();
  updateCaptured();updateUI();drawBoard();
  document.getElementById('undo-btn').disabled=!history.length;
  playTone(300,0.06);
}

function updateCaptured(){
  const region=getConnected(board[0][0]);
  captured=region.length;
}

function updateUI(){
  const movesEl=document.getElementById('moves');
  movesEl.textContent=moves;
  movesEl.classList.add('bump');setTimeout(()=>movesEl.classList.remove('bump'),150);
  const remaining=PAR[boardSize]-moves;
  const remEl=document.getElementById('remaining');
  remEl.textContent=remaining;
  remEl.style.color=remaining<=3&&remaining>0?'#e94560':remaining<=0?'#ff0000':'#fff';
  document.getElementById('pct').textContent=Math.round(captured/totalCells*100)+'%';
  document.getElementById('message').textContent=
    captured===totalCells?'ðŸŽ‰ Complete!':
    moves>=PAR[boardSize]?'Over par...':'';
  
  const currentColor=board[0][0];
  document.querySelectorAll('.color-btn').forEach((btn,i)=>{
    btn.classList.toggle('current',i===currentColor);
    btn.classList.toggle('disabled',i===currentColor);
  });
}

function drawBoard(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<boardSize;y++){
    for(let x=0;x<boardSize;x++){
      ctx.fillStyle=colors[board[y][x]];
      ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
      
      // Animate new cells with a scale/flash effect
      const key=x+','+y;
      const anim=animCells.get(key);
      if(anim&&anim.progress<1){
        anim.progress=Math.min(1,anim.progress+0.06);
        const p=anim.progress;
        // White flash that fades out
        const flash=p<0.3?p/0.3:(1-p)/0.7;
        ctx.fillStyle='rgba(255,255,255,'+Math.max(0,flash*0.5)+')';
        ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
        // Scale-in from center
        if(p<0.4){
          const s=0.5+p/0.4*0.5;
          const off=(1-s)*cellSize*0.5;
          ctx.fillStyle=colors[board[y][x]];
          ctx.fillRect(x*cellSize+off,y*cellSize+off,cellSize*s,cellSize*s);
        }
        if(anim.progress>=1)animCells.delete(key);
      }
    }
  }
  
  // Grid lines
  ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=0.5;
  for(let i=0;i<=boardSize;i++){
    ctx.beginPath();ctx.moveTo(i*cellSize,0);ctx.lineTo(i*cellSize,boardSize*cellSize);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,i*cellSize);ctx.lineTo(boardSize*cellSize,i*cellSize);ctx.stroke();
  }
  
  // Region border highlight
  const region=getConnected(board[0][0]);
  const regionSet=new Set(region.map(p=>p.x+','+p.y));
  ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1.5;
  for(const{x,y}of region){
    if(!regionSet.has(x+','+(y-1))){ctx.beginPath();ctx.moveTo(x*cellSize,y*cellSize);ctx.lineTo((x+1)*cellSize,y*cellSize);ctx.stroke()}
    if(!regionSet.has(x+','+(y+1))){ctx.beginPath();ctx.moveTo(x*cellSize,(y+1)*cellSize);ctx.lineTo((x+1)*cellSize,(y+1)*cellSize);ctx.stroke()}
    if(!regionSet.has((x-1)+','+y)){ctx.beginPath();ctx.moveTo(x*cellSize,y*cellSize);ctx.lineTo(x*cellSize,(y+1)*cellSize);ctx.stroke()}
    if(!regionSet.has((x+1)+','+y)){ctx.beginPath();ctx.moveTo((x+1)*cellSize,y*cellSize);ctx.lineTo((x+1)*cellSize,(y+1)*cellSize);ctx.stroke()}
  }
  
  // Keep animating if needed â€” throttled to prevent excessive redraws
  if(animCells.size>0&&!animRunning){
    animRunning=true;
    requestAnimationFrame(()=>{animRunning=false;drawBoard()});
  }
}

function winGame(){
  const par=PAR[boardSize];
  const stars=moves<=par-5?3:moves<=par?2:1;
  const key=`colorflood_${boardSize}`;
  const prev=parseInt(localStorage.getItem(key))||999;
  if(moves<prev)localStorage.setItem(key,moves);
  
  document.getElementById('win-text').textContent=
    stars===3?'ðŸŽ‰ Perfect!':stars===2?'âœ¨ Well Done!':'Board Cleared!';
  document.getElementById('win-stars').textContent='â˜…'.repeat(stars)+'â˜†'.repeat(3-stars);
  document.getElementById('win-detail').textContent=`${moves} moves (par: ${par})${moves<prev?' â€” New Best!':''}`;
  document.getElementById('win-screen').classList.remove('hidden');
  
  playTone(523,0.15);setTimeout(()=>playTone(659,0.15),100);setTimeout(()=>playTone(784,0.2),200);
}

// Keyboard shortcuts
document.addEventListener('keydown',e=>{
  const n=parseInt(e.key);
  if(n>=1&&n<=6&&colors)makeMove(n-1);
  if(e.key==='z'&&(e.ctrlKey||e.metaKey))undoMove();
});
</script>
</body>
</html>
