<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Pixel Painter</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a2e">
<meta name="description" content="Create pixel art with layers, PNG export, undo/redo, and color picker">
<meta property="og:title" content="Pixel Painter â€” Mobile Games Lab">
<meta property="og:description" content="Pixel art creator with layers, export, and full color tools">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pixel Painter">
<meta name="twitter:description" content="Browser-based pixel art creator with layers and export">
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
body{background:#1a1a2e;overflow:hidden;font-family:-apple-system,system-ui,sans-serif;color:#fff;display:flex;flex-direction:column;height:100vh;touch-action:none}
#toolbar{display:flex;align-items:center;padding:6px;gap:4px;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);z-index:10;flex-wrap:wrap}
#toolbar button{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 10px;border-radius:8px;font-size:13px;cursor:pointer;min-width:36px;min-height:36px}
#toolbar button.active{background:rgba(255,217,61,0.2);border-color:#ffd93d}
#toolbar button:active{transform:scale(0.95)}
#size-display{font-size:11px;color:#888;margin-left:auto}
canvas{flex:1;display:block;background:#16213e}
#palette{display:flex;padding:4px;gap:3px;background:rgba(0,0,0,0.4);flex-wrap:wrap;justify-content:center;align-items:center}
.swatch{width:28px;height:28px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .1s}
.swatch.active{border-color:#fff;transform:scale(1.15);box-shadow:0 0 10px rgba(255,255,255,0.3)}
#custom-color{width:28px;height:28px;border-radius:6px;border:2px solid rgba(255,255,255,0.3);cursor:pointer;background:none;padding:0;appearance:none;-webkit-appearance:none}
#custom-color::-webkit-color-swatch-wrapper{padding:0}
#custom-color::-webkit-color-swatch{border:none;border-radius:4px}
#bottom-bar{display:flex;padding:6px;gap:4px;background:rgba(0,0,0,0.4);justify-content:center;flex-wrap:wrap}
#bottom-bar button{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer;min-height:36px}
#bottom-bar button:active{transform:scale(0.95)}
#bottom-bar button.mode-active{background:rgba(233,69,96,0.2);border-color:#e94560}

/* Gallery */
#gallery{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.97);z-index:20;overflow-y:auto;padding:16px}
#gallery h2{text-align:center;margin-bottom:16px}
#gallery .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
#gallery .gallery-item{aspect-ratio:1;background:#16213e;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid rgba(255,255,255,0.1);position:relative}
#gallery .gallery-item img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
#gallery .gallery-item .del-btn{position:absolute;top:2px;right:2px;background:rgba(233,69,96,0.8);border:none;color:#fff;width:22px;height:22px;border-radius:50%;font-size:12px;cursor:pointer;display:none}
#gallery .gallery-item:hover .del-btn{display:block}
#gallery .close-btn{position:fixed;top:16px;right:16px;background:rgba(255,255,255,0.1);border:none;color:#fff;width:40px;height:40px;border-radius:50%;font-size:20px;cursor:pointer}
.hidden{display:none!important}

/* Mode bar */
#mode-bar{text-align:center;padding:6px;background:rgba(255,217,61,0.1);font-size:12px;color:#ffd93d}
#mode-bar.challenge-mode{background:rgba(233,69,96,0.15);color:#e94560}

/* Hex input */
#hex-input-wrap{display:flex;align-items:center;gap:4px;margin-left:4px}
#hex-input{width:72px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-family:monospace;font-size:13px;padding:6px 8px;border-radius:6px;text-transform:uppercase}
#hex-preview{width:28px;height:28px;border-radius:6px;border:2px solid rgba(255,255,255,0.3)}

/* Layer panel */
#layer-panel{display:flex;flex-direction:column;gap:2px;padding:6px;background:rgba(0,0,0,0.5);max-height:140px;overflow-y:auto}
#layer-panel .layer-row{display:flex;align-items:center;gap:4px;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:12px;background:rgba(255,255,255,0.04)}
#layer-panel .layer-row.active{background:rgba(255,217,61,0.15);border:1px solid rgba(255,217,61,0.3)}
#layer-panel .layer-row .vis-btn{background:none;border:none;color:#fff;font-size:14px;cursor:pointer;padding:0 2px;opacity:0.7}
#layer-panel .layer-row .vis-btn:hover{opacity:1}
#layer-panel .layer-row .layer-name{flex:1;color:#ccc;font-size:11px}
#layer-panel .layer-row.active .layer-name{color:#ffd93d}
#layer-panel .layer-row .opacity-slider{width:50px;height:4px;accent-color:#ffd93d}
#layer-controls{display:flex;gap:4px;padding:4px 6px;background:rgba(0,0,0,0.4);justify-content:center}
#layer-controls button{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer}
#layer-controls button:active{transform:scale(0.95)}

/* Challenge overlay */
#challenge-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.95);z-index:25;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
#challenge-overlay h2{font-size:24px;margin-bottom:8px}
#challenge-overlay p{color:#888;margin-bottom:16px;font-size:14px}
#challenge-overlay button{background:linear-gradient(135deg,#e94560,#c23152);border:none;color:#fff;padding:14px 28px;border-radius:50px;font-size:16px;font-weight:700;cursor:pointer;margin:6px}
#challenge-overlay button:active{transform:scale(0.95)}
#challenge-overlay button.sec{background:rgba(255,255,255,0.1)}
#challenge-overlay .ref-canvas{border:2px solid rgba(255,255,255,0.2);border-radius:8px;image-rendering:pixelated;margin:12px 0}

/* Score display */
#score-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:30;text-align:center;background:rgba(26,26,46,0.95);border-radius:20px;padding:30px;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px)}
#score-popup h2{font-size:28px;margin-bottom:8px}
#score-popup .score-num{font-size:48px;font-weight:900;background:linear-gradient(135deg,#ffd93d,#e94560);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
#score-popup .star{font-size:32px}
#score-popup p{color:#888;margin:6px 0}
#score-popup button{background:linear-gradient(135deg,#4d96ff,#a55eea);border:none;color:#fff;padding:12px 28px;border-radius:50px;font-size:15px;font-weight:700;cursor:pointer;margin-top:12px}

/* Tutorial */
#tutorial{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.97);z-index:30;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
#tutorial h2{font-size:26px;margin-bottom:16px}
#tutorial .tut-item{display:flex;align-items:center;gap:12px;text-align:left;padding:8px 0;width:100%;max-width:300px}
#tutorial .tut-icon{font-size:24px;min-width:36px;text-align:center}
#tutorial .tut-text{font-size:13px;color:#ccc}
#tutorial .tut-text b{color:#fff}
#tutorial button{background:linear-gradient(135deg,#6bcb77,#1dd1a1);border:none;color:#fff;padding:14px 36px;border-radius:50px;font-size:16px;font-weight:700;cursor:pointer;margin-top:20px}

/* Layer indicator */
#layer-bar{display:flex;gap:4px;align-items:center;padding:2px 6px;background:rgba(0,0,0,0.3);border-radius:6px;margin-left:4px}
#layer-bar button{font-size:11px;padding:4px 8px;min-width:unset;min-height:unset}
#layer-bar button.active{background:rgba(255,217,61,0.3);border-color:#ffd93d}
</style>
</head>
<body>
<div id="mode-bar">Free Draw Mode - Daily Prompt: <span id="daily-prompt">Loading...</span></div>
<div id="toolbar">
  <button id="btn-draw" class="active" onclick="setTool('draw')">&#9999;&#65039;</button>
  <button id="btn-erase" onclick="setTool('erase')">&#128465;</button>
  <button id="btn-fill" onclick="setTool('fill')">&#127912;</button>
  <button id="btn-pick" onclick="setTool('pick')">&#128083;</button>
  <button id="btn-line" onclick="setTool('line')">&#9585;</button>
  <button id="btn-mirror" onclick="toggleMirror()">&#129693;</button>
  <button id="btn-undo" onclick="undo()">&#8617;</button>
  <button id="btn-redo" onclick="redo()">&#8618;</button>
  <div id="layer-bar">
    <button class="active" onclick="setLayer(0)" id="layer0-btn">BG</button>
    <button onclick="setLayer(1)" id="layer1-btn">FG</button>
  </div>
  <span id="size-display">16x16</span>
</div>
<canvas id="c"></canvas>
<div id="palette">
  <div id="hex-input-wrap">
    <div id="hex-preview"></div>
    <input type="text" id="hex-input" maxlength="7" placeholder="#FF6B6B" spellcheck="false">
  </div>
</div>
<div id="layer-controls">
  <button onclick="addLayer()">+ Layer</button>
  <button onclick="deleteLayer()">&#128465;</button>
  <button onclick="moveLayer(-1)">&#9650;</button>
  <button onclick="moveLayer(1)">&#9660;</button>
  <button onclick="mergeDown()">&#10549; Merge</button>
</div>
<div id="layer-panel"></div>
<div id="bottom-bar">
  <button onclick="changeSize(-4)">&#10134; Size</button>
  <button onclick="changeSize(4)">&#10133; Size</button>
  <button onclick="saveToGallery()">&#128190; Save</button>
  <button onclick="showGallery()">&#128444;&#65039; Gallery</button>
  <button onclick="exportPNG()">&#128229; Export PNG</button>
  <button id="btn-challenge" onclick="showChallengeMenu()">Challenge</button>
  <button onclick="clearCanvas()">Clear</button>
</div>
<div id="gallery" class="hidden">
  <button class="close-btn" onclick="hideGallery()">&#10005;</button>
  <h2>Gallery</h2>
  <div class="gallery-grid" id="gallery-grid"></div>
</div>

<div id="challenge-overlay" class="hidden"></div>
<div id="score-popup" class="hidden"></div>

<div id="tutorial" class="hidden">
  <h2>How to Play</h2>
  <div class="tut-item"><div class="tut-icon">&#9999;&#65039;</div><div class="tut-text"><b>Draw</b> - Tap pixels to paint them</div></div>
  <div class="tut-item"><div class="tut-icon">&#128465;</div><div class="tut-text"><b>Erase</b> - Remove pixels</div></div>
  <div class="tut-item"><div class="tut-icon">&#127912;</div><div class="tut-text"><b>Fill</b> - Flood fill an area</div></div>
  <div class="tut-item"><div class="tut-icon">&#128083;</div><div class="tut-text"><b>Eyedropper</b> - Pick a color from canvas</div></div>
  <div class="tut-item"><div class="tut-icon">&#9585;</div><div class="tut-text"><b>Line</b> - Draw straight lines</div></div>
  <div class="tut-item"><div class="tut-icon">&#129693;</div><div class="tut-text"><b>Mirror</b> - Symmetric drawing mode</div></div>
  <div class="tut-item"><div class="tut-icon">BG/FG</div><div class="tut-text"><b>Layers</b> - Background and foreground layers</div></div>
  <div class="tut-item"><div class="tut-icon">&#127942;</div><div class="tut-text"><b>Challenge</b> - Recreate reference art for a score!</div></div>
  <button onclick="closeTutorial()">Got it!</button>
</div>

<script>
const C=document.getElementById('c'),X=C.getContext('2d');
const COLORS=[
  '#000000','#ffffff','#ff6b6b','#e94560','#c23152','#a55eea','#6c5ce7',
  '#4d96ff','#74b9ff','#0abde3','#1dd1a1','#6bcb77','#badc58','#ffd93d',
  '#fdcb6e','#e17055','#d63031','#b33939','#6d4c41','#8d6e63',
  '#bdbdbd','#757575','#424242','#2d3436','#636e72','#dfe6e9',
  '#fab1a0','#ffeaa7','#55efc4','#81ecec','#a29bfe','#fd79a8'
];

let audioCtx;
function ensureAudio(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
  return audioCtx;
}
function snd(f,d,t='sine',v=0.06){
  try{
    let a=ensureAudio();
    const o=a.createOscillator(),g=a.createGain();
    o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);
    o.connect(g);g.connect(a.destination);o.start();o.stop(a.currentTime+d);
  }catch(e){}
}

function saveData(key,data){try{localStorage.setItem(key,JSON.stringify(data))}catch(e){}}
function loadData(key){try{return JSON.parse(localStorage.getItem(key))}catch(e){return null}}

let gridSize=16,tool='draw',currentColor='#ff6b6b';
let layers=[],activeLayerIdx=0;
let history=[],historyIdx=-1,maxHistory=50;
let cellPx,offX,offY,drawing=false;
let mirrorMode=false;
let lineStart=null;

// Challenge mode state
let challengeMode=null; // null, 'pixel-art', 'timed-draw', 'daily'
let challengeRef=null; // reference pixel data for pixel-art challenge
let challengeTimer=0;
let challengeTimerInterval=null;
let challengePromptText='';

const PROMPTS=['a sunset','your pet','a robot','a tree','a spaceship','a castle','a dragon','pizza','a ghost','the ocean','a mountain','a flower','a cat face','a mushroom','a sword','rainy day','a star','your mood','a burger','the moon','a house','a bird','a fish','a heart','a skull','fire','ice cream','a rainbow','a crown','lightning','a cactus','clouds','a boat','a volcano','a diamond','a trophy','a rocket','an alien','a planet','a cookie'];

// Reference pixel art patterns (8x8 for challenges)
const REF_PATTERNS=[
  {name:'Heart',size:8,colors:['#e94560'],data:[
    [0,0,0,0,0,0,0,0],[0,0,1,0,0,1,0,0],[0,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0],[0,0,0,1,1,0,0,0],[0,0,0,0,0,0,0,0]]},
  {name:'Star',size:8,colors:['#ffd93d'],data:[
    [0,0,0,1,0,0,0,0],[0,0,0,1,0,0,0,0],[0,1,1,1,1,1,0,0],[0,0,1,1,1,0,0,0],
    [0,1,1,0,1,1,0,0],[0,1,0,0,0,1,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]},
  {name:'Mushroom',size:8,colors:['#e94560','#ffeaa7','#8d6e63'],data:[
    [0,0,1,1,1,0,0,0],[0,1,1,1,1,1,0,0],[1,1,0,1,0,1,1,0],[1,1,1,1,1,1,1,0],
    [0,2,2,2,2,2,0,0],[0,0,2,2,2,0,0,0],[0,0,3,3,3,0,0,0],[0,0,3,3,3,0,0,0]]},
  {name:'Smiley',size:8,colors:['#ffd93d','#000000'],data:[
    [0,0,1,1,1,1,0,0],[0,1,1,1,1,1,1,0],[1,1,2,1,1,2,1,0],[1,1,1,1,1,1,1,0],
    [1,2,1,1,1,1,2,0],[1,1,2,2,2,2,1,0],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0]]},
  {name:'Sword',size:8,colors:['#bdbdbd','#8d6e63','#ffd93d'],data:[
    [0,0,0,0,0,0,1,0],[0,0,0,0,0,1,1,0],[0,0,0,0,1,1,0,0],[0,0,0,1,1,0,0,0],
    [0,3,1,1,0,0,0,0],[0,2,3,0,0,0,0,0],[0,2,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]},
  {name:'Alien',size:8,colors:['#1dd1a1','#000000'],data:[
    [0,0,1,1,1,1,0,0],[0,1,1,1,1,1,1,0],[1,2,2,1,1,2,2,0],[1,1,1,1,1,1,1,0],
    [0,1,2,1,2,1,0,0],[0,0,1,1,1,0,0,0],[0,1,0,0,0,1,0,0],[1,0,0,0,0,0,1,0]]},
  {name:'Tree',size:8,colors:['#6bcb77','#8d6e63'],data:[
    [0,0,0,1,0,0,0,0],[0,0,1,1,1,0,0,0],[0,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,0,0],[0,0,0,2,0,0,0,0],[0,0,0,2,0,0,0,0],[0,0,0,2,0,0,0,0]]},
  {name:'Ghost',size:8,colors:['#dfe6e9','#000000'],data:[
    [0,0,1,1,1,0,0,0],[0,1,1,1,1,1,0,0],[1,2,2,1,2,2,1,0],[1,1,1,1,1,1,1,0],
    [1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0]]}
];

function makePixels(){
  let p=[];
  for(let y=0;y<gridSize;y++){p[y]=[];for(let x=0;x<gridSize;x++)p[y][x]=null}
  return p;
}
function makeLayer(name){return{name,pixels:makePixels(),visible:true,opacity:1}}
function initLayers(){
  layers=[makeLayer('Layer 1')];
  activeLayerIdx=0;
  history=[];historyIdx=-1;
  pushHistory();
  renderLayerPanel();
}
function getPixels(){return layers[activeLayerIdx].pixels}

function getAllPixels(){
  // Composite all visible layers bottom to top
  let result=[];
  for(let y=0;y<gridSize;y++){
    result[y]=[];
    for(let x=0;x<gridSize;x++){
      result[y][x]=null;
      for(let li=layers.length-1;li>=0;li--){
        if(layers[li].visible&&layers[li].pixels[y]&&layers[li].pixels[y][x]){
          result[y][x]=layers[li].pixels[y][x];
          break;
        }
      }
    }
  }
  return result;
}

function toggleMirror(){
  mirrorMode=!mirrorMode;
  document.getElementById('btn-mirror').classList.toggle('active',mirrorMode);
  snd(mirrorMode?600:400,0.1);
}

function pushHistory(){
  history=history.slice(0,historyIdx+1);
  const snap=layers.map(l=>({name:l.name,pixels:JSON.parse(JSON.stringify(l.pixels)),visible:l.visible,opacity:l.opacity}));
  history.push({layers:snap,activeLayerIdx});
  if(history.length>maxHistory)history.shift();
  historyIdx=history.length-1;
}

function undo(){
  if(historyIdx>0){
    historyIdx--;
    const snap=history[historyIdx];
    layers=snap.layers.map(l=>({name:l.name,pixels:JSON.parse(JSON.stringify(l.pixels)),visible:l.visible,opacity:l.opacity}));
    activeLayerIdx=snap.activeLayerIdx;
    renderLayerPanel();
    snd(300,0.05);
  }
}
function redo(){
  if(historyIdx<history.length-1){
    historyIdx++;
    const snap=history[historyIdx];
    layers=snap.layers.map(l=>({name:l.name,pixels:JSON.parse(JSON.stringify(l.pixels)),visible:l.visible,opacity:l.opacity}));
    activeLayerIdx=snap.activeLayerIdx;
    renderLayerPanel();
    snd(500,0.05);
  }
}

function resize(){
  let dpr=window.devicePixelRatio||1;
  let w=window.innerWidth;
  let toolbarH=document.getElementById('toolbar').offsetHeight;
  let paletteH=document.getElementById('palette').offsetHeight;
  let bottomH=document.getElementById('bottom-bar').offsetHeight;
  let modeH=document.getElementById('mode-bar').offsetHeight;
  let layerH=document.getElementById('layer-panel').offsetHeight+(document.getElementById('layer-controls').offsetHeight||0);
  let h=window.innerHeight-toolbarH-paletteH-bottomH-modeH-layerH;
  C.width=w*dpr;C.height=h*dpr;
  C.style.width=w+'px';C.style.height=h+'px';
  X.setTransform(dpr,0,0,dpr,0,0);
  cellPx=Math.floor(Math.min(w,h)*0.9/gridSize);
  offX=(w-gridSize*cellPx)/2;
  offY=(h-gridSize*cellPx)/2;
}

function render(){
  let w=C.width/(window.devicePixelRatio||1);
  let h=C.height/(window.devicePixelRatio||1);
  X.fillStyle='#16213e';X.fillRect(0,0,w,h);

  // Checkerboard for transparency
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      let px=offX+x*cellPx,py=offY+y*cellPx;
      X.fillStyle=(x+y)%2===0?'rgba(255,255,255,0.03)':'rgba(255,255,255,0.06)';
      X.fillRect(px,py,cellPx,cellPx);
    }
  }

  // Composite visible layers bottom to top
  for(let li=layers.length-1;li>=0;li--){
    const layer=layers[li];
    if(!layer.visible)continue;
    X.globalAlpha=layer.opacity;
    for(let y=0;y<gridSize;y++){
      for(let x=0;x<gridSize;x++){
        if(layer.pixels[y]&&layer.pixels[y][x]){
          X.fillStyle=layer.pixels[y][x];
          X.fillRect(offX+x*cellPx,offY+y*cellPx,cellPx,cellPx);
        }
      }
    }
  }
  X.globalAlpha=1;

  // Active layer highlight border
  const al=layers[activeLayerIdx];
  if(al){
    for(let y=0;y<gridSize;y++){
      for(let x=0;x<gridSize;x++){
        if(al.pixels[y]&&al.pixels[y][x]){
          X.strokeStyle='rgba(255,217,61,0.15)';X.lineWidth=0.5;
          X.strokeRect(offX+x*cellPx,offY+y*cellPx,cellPx,cellPx);
        }
      }
    }
  }

  // Challenge mode: show reference overlay
  if(challengeMode==='pixel-art'&&challengeRef){
    let refSize=challengeRef.length;
    let scale=gridSize/refSize;
    X.globalAlpha=0.15;
    for(let y=0;y<refSize;y++){
      for(let x=0;x<refSize;x++){
        if(challengeRef[y][x]){
          X.fillStyle=challengeRef[y][x];
          let px=offX+x*scale*cellPx,py=offY+y*scale*cellPx;
          X.fillRect(px,py,cellPx*scale,cellPx*scale);
        }
      }
    }
    X.globalAlpha=1;
  }

  // Grid lines
  X.strokeStyle='rgba(255,255,255,0.08)';X.lineWidth=0.5;
  for(let i=0;i<=gridSize;i++){
    X.beginPath();X.moveTo(offX+i*cellPx,offY);X.lineTo(offX+i*cellPx,offY+gridSize*cellPx);X.stroke();
    X.beginPath();X.moveTo(offX,offY+i*cellPx);X.lineTo(offX+gridSize*cellPx,offY+i*cellPx);X.stroke();
  }

  // Line preview
  if(tool==='line'&&lineStart&&drawing){
    X.strokeStyle=currentColor;X.lineWidth=2;X.globalAlpha=0.5;
    let sx=offX+lineStart.x*cellPx+cellPx/2,sy=offY+lineStart.y*cellPx+cellPx/2;
    let ex=offX+(lineEnd?lineEnd.x:lineStart.x)*cellPx+cellPx/2;
    let ey=offY+(lineEnd?lineEnd.y:lineStart.y)*cellPx+cellPx/2;
    X.beginPath();X.moveTo(sx,sy);X.lineTo(ex,ey);X.stroke();
    X.globalAlpha=1;
  }

  requestAnimationFrame(render);
}

let lineEnd=null;

function getCellFromEvent(e){
  let rect=C.getBoundingClientRect();
  let cx=e.clientX||(e.touches&&e.touches[0]?e.touches[0].clientX:0);
  let cy=e.clientY||(e.touches&&e.touches[0]?e.touches[0].clientY:0);
  let px=cx-rect.left;
  let py=cy-rect.top;
  let x=Math.floor((px-offX)/cellPx);
  let y=Math.floor((py-offY)/cellPx);
  if(x<0||x>=gridSize||y<0||y>=gridSize)return null;
  return{x,y};
}

function paint(cell){
  if(!cell)return;
  const px=getPixels();
  if(tool==='pick'){
    // Pick from composited view (check all visible layers top to bottom)
    for(let li=0;li<layers.length;li++){
      if(layers[li].visible&&layers[li].pixels[cell.y][cell.x]){
        currentColor=layers[li].pixels[cell.y][cell.x];
        updateColorUI();
        tool='draw';setTool('draw');
        return;
      }
    }
    return;
  }
  if(tool==='draw'){
    px[cell.y][cell.x]=currentColor;
    if(mirrorMode&&gridSize-1-cell.x!==cell.x)px[cell.y][gridSize-1-cell.x]=currentColor;
  }
  else if(tool==='erase'){
    px[cell.y][cell.x]=null;
    if(mirrorMode)px[cell.y][gridSize-1-cell.x]=null;
  }
  else if(tool==='fill'){floodFill(cell.x,cell.y,px[cell.y][cell.x],currentColor)}
}

function drawLine(x0,y0,x1,y1){
  let pixels=getPixels();
  let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0);
  let sx=x0<x1?1:-1,sy=y0<y1?1:-1;
  let err=dx-dy;
  while(true){
    if(x0>=0&&x0<gridSize&&y0>=0&&y0<gridSize){
      pixels[y0][x0]=currentColor;
      if(mirrorMode)pixels[y0][gridSize-1-x0]=currentColor;
    }
    if(x0===x1&&y0===y1)break;
    let e2=2*err;
    if(e2>-dy){err-=dy;x0+=sx}
    if(e2<dx){err+=dx;y0+=sy}
  }
}

function floodFill(x,y,target,fill){
  if(target===fill)return;
  const px=getPixels();
  let stack=[{x,y}];
  let visited=new Set();
  while(stack.length){
    let{x:cx,y:cy}=stack.pop();
    if(cx<0||cx>=gridSize||cy<0||cy>=gridSize)continue;
    let key=cy*gridSize+cx;
    if(visited.has(key))continue;
    visited.add(key);
    if(px[cy][cx]!==target)continue;
    px[cy][cx]=fill;
    stack.push({x:cx+1,y:cy},{x:cx-1,y:cy},{x:cx,y:cy+1},{x:cx,y:cy-1});
  }
}

C.addEventListener('touchstart',e=>{
  e.preventDefault();ensureAudio();drawing=true;
  let c=getCellFromEvent(e);
  if(tool==='line'){lineStart=c;lineEnd=c}
  else paint(c);
});
C.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(drawing){
    let c=getCellFromEvent(e);
    if(tool==='line'){lineEnd=c}
    else paint(c);
  }
});
C.addEventListener('touchend',e=>{
  e.preventDefault();
  if(drawing){
    if(tool==='line'&&lineStart&&lineEnd){
      drawLine(lineStart.x,lineStart.y,lineEnd.x,lineEnd.y);
      lineStart=null;lineEnd=null;
    }
    drawing=false;pushHistory();
  }
});
C.addEventListener('mousedown',e=>{
  ensureAudio();drawing=true;
  let c=getCellFromEvent(e);
  if(tool==='line'){lineStart=c;lineEnd=c}
  else paint(c);
});
C.addEventListener('mousemove',e=>{
  if(drawing){
    let c=getCellFromEvent(e);
    if(tool==='line'){lineEnd=c}
    else paint(c);
  }
});
C.addEventListener('mouseup',()=>{
  if(drawing){
    if(tool==='line'&&lineStart&&lineEnd){
      drawLine(lineStart.x,lineStart.y,lineEnd.x,lineEnd.y);
      lineStart=null;lineEnd=null;
    }
    drawing=false;pushHistory();
  }
});

function setTool(t){
  tool=t;lineStart=null;lineEnd=null;
  document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
  let btn=document.getElementById('btn-'+t);
  if(btn)btn.classList.add('active');
  if(mirrorMode)document.getElementById('btn-mirror').classList.add('active');
}

function setLayer(l){
  activeLayerIdx=l;
  document.getElementById('layer0-btn').classList.toggle('active',l===0);
  document.getElementById('layer1-btn').classList.toggle('active',l===1);
  renderLayerPanel();
  snd(l?500:400,0.05);
}

function clearCanvas(){
  if(!confirm('Clear active layer? This can be undone.'))return;
  const px=getPixels();
  for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++)px[y][x]=null;
  pushHistory();snd(200,0.1);
}

function changeSize(d){
  gridSize=Math.max(8,Math.min(64,gridSize+d));
  document.getElementById('size-display').textContent=`${gridSize}x${gridSize}`;
  initLayers();resize();snd(400+d*20,0.08);
}

function compositeLayers(tx,scale=1){
  for(let li=layers.length-1;li>=0;li--){
    const layer=layers[li];
    if(!layer.visible)continue;
    tx.globalAlpha=layer.opacity;
    for(let y=0;y<gridSize;y++){
      for(let x=0;x<gridSize;x++){
        if(layer.pixels[y]&&layer.pixels[y][x]){
          tx.fillStyle=layer.pixels[y][x];
          tx.fillRect(x*scale,y*scale,scale,scale);
        }
      }
    }
  }
  tx.globalAlpha=1;
}

function toDataURL(scale){
  let s=scale||1;
  let tc=document.createElement('canvas');
  tc.width=gridSize*s;tc.height=gridSize*s;
  let tx=tc.getContext('2d');
  compositeLayers(tx,s);
  return tc.toDataURL();
}

function saveToGallery(){
  let gallery=loadData('pixelpainter_gallery')||[];
  gallery.unshift({data:toDataURL(),date:Date.now(),size:gridSize});
  if(gallery.length>50)gallery.pop();
  saveData('pixelpainter_gallery',gallery);
  snd(600,0.1);snd(800,0.08,'triangle');
  document.body.style.background='#2a2a4e';
  setTimeout(()=>document.body.style.background='#1a1a2e',200);
}

function showGallery(){
  let gallery=loadData('pixelpainter_gallery')||[];
  let grid=document.getElementById('gallery-grid');
  grid.innerHTML='';
  if(gallery.length===0){grid.innerHTML='<p style="color:#888;text-align:center;grid-column:1/-1">No saved art yet! Draw something and hit Save.</p>'}
  gallery.forEach((item,i)=>{
    let div=document.createElement('div');div.className='gallery-item';
    let img=document.createElement('img');img.src=item.data;
    let del=document.createElement('button');del.className='del-btn';del.textContent='x';
    del.onclick=(e)=>{
      e.stopPropagation();
      gallery.splice(i,1);
      saveData('pixelpainter_gallery',gallery);
      showGallery();
    };
    div.appendChild(img);div.appendChild(del);
    div.onclick=()=>{
      // Load image back as pixels
      let tc=document.createElement('canvas');tc.width=item.size;tc.height=item.size;
      let tx=tc.getContext('2d');
      let img2=new Image();
      img2.onload=()=>{
        tx.drawImage(img2,0,0);
        gridSize=item.size;
        document.getElementById('size-display').textContent=`${gridSize}x${gridSize}`;
        initLayers();resize();
        let px=getPixels();
        for(let y=0;y<gridSize;y++){
          for(let x=0;x<gridSize;x++){
            let d=tx.getImageData(x,y,1,1).data;
            if(d[3]>0){
              px[y][x]=`rgb(${d[0]},${d[1]},${d[2]})`;
            }
          }
        }
        pushHistory();
        hideGallery();
        snd(500,0.1);
      };
      img2.src=item.data;
    };
    grid.appendChild(div);
  });
  document.getElementById('gallery').classList.remove('hidden');
}

function hideGallery(){document.getElementById('gallery').classList.add('hidden')}

function exportPNG(){
  let tc=document.createElement('canvas');
  const scale=Math.max(4,Math.floor(512/gridSize));
  tc.width=gridSize*scale;tc.height=gridSize*scale;
  let tx=tc.getContext('2d');
  tx.fillStyle='#16213e';tx.fillRect(0,0,tc.width,tc.height);
  compositeLayers(tx,scale);
  let a=document.createElement('a');a.href=tc.toDataURL();a.download='pixel-art-'+Date.now()+'.png';a.click();
  snd(600,0.1);
}

// === CHALLENGE MODES ===

function showChallengeMenu(){
  let overlay=document.getElementById('challenge-overlay');
  overlay.innerHTML=`
    <h2>Challenge Modes</h2>
    <p>Test your pixel art skills!</p>
    <button onclick="startPixelChallenge()">Pixel Art Challenge</button>
    <button onclick="startTimedDraw()">Timed Drawing (30s)</button>
    <button onclick="startDailyChallenge()">Daily Challenge</button>
    <button class="sec" onclick="closeChallengeMenu()">Back to Free Draw</button>
  `;
  overlay.classList.remove('hidden');
}

function closeChallengeMenu(){
  document.getElementById('challenge-overlay').classList.add('hidden');
  endChallenge();
}

function endChallenge(){
  challengeMode=null;challengeRef=null;
  if(challengeTimerInterval){clearInterval(challengeTimerInterval);challengeTimerInterval=null}
  let bar=document.getElementById('mode-bar');
  bar.className='';
  let day=Math.floor(Date.now()/86400000);
  bar.textContent='Free Draw Mode - Daily Prompt: '+PROMPTS[day%PROMPTS.length];
}

function startPixelChallenge(){
  snd(500,0.1);
  let pattern=REF_PATTERNS[Math.floor(Math.random()*REF_PATTERNS.length)];

  // Build reference pixel data
  let refPixels=[];
  for(let y=0;y<pattern.size;y++){
    refPixels[y]=[];
    for(let x=0;x<pattern.size;x++){
      let v=pattern.data[y][x];
      refPixels[y][x]=v>0?pattern.colors[v-1]:null;
    }
  }
  challengeRef=refPixels;
  challengeMode='pixel-art';

  // Show reference preview
  let refCanvas=document.createElement('canvas');
  refCanvas.width=pattern.size*20;refCanvas.height=pattern.size*20;
  let rx=refCanvas.getContext('2d');
  for(let y=0;y<pattern.size;y++){
    for(let x=0;x<pattern.size;x++){
      if(refPixels[y][x]){rx.fillStyle=refPixels[y][x];rx.fillRect(x*20,y*20,20,20)}
      else{rx.fillStyle=(x+y)%2===0?'#1a1a2e':'#1e1e3a';rx.fillRect(x*20,y*20,20,20)}
    }
  }

  // Set grid to match
  gridSize=pattern.size;
  document.getElementById('size-display').textContent=`${gridSize}x${gridSize}`;
  initLayers();resize();

  let overlay=document.getElementById('challenge-overlay');
  overlay.innerHTML=`
    <h2>Recreate: ${pattern.name}</h2>
    <p>Match the reference image as closely as you can!</p>
    <img class="ref-canvas" src="${refCanvas.toDataURL()}" width="160" height="160">
    <p style="font-size:12px;color:#666">A ghost overlay will guide you on the canvas</p>
    <button onclick="beginPixelChallenge()">Start Drawing!</button>
  `;
  overlay.classList.remove('hidden');

  let bar=document.getElementById('mode-bar');
  bar.className='challenge-mode';
  bar.textContent='Pixel Art Challenge: '+pattern.name;
}

function beginPixelChallenge(){
  document.getElementById('challenge-overlay').classList.add('hidden');
  // Add a submit button temporarily
  let bar=document.getElementById('mode-bar');
  bar.innerHTML='Pixel Art Challenge <button onclick="scorePixelChallenge()" style="background:#e94560;border:none;color:#fff;padding:4px 16px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;margin-left:8px">Submit</button>';
}

function scorePixelChallenge(){
  if(!challengeRef)return;
  let total=0,correct=0;
  let composite=getAllPixels();
  for(let y=0;y<challengeRef.length;y++){
    for(let x=0;x<challengeRef[y].length;x++){
      let ref=challengeRef[y][x];
      let cur=composite[y]?composite[y][x]:null;
      if(ref||cur)total++;
      if(ref&&cur){
        // Color similarity check
        if(ref===cur)correct++;
        else{
          // Partial credit for close colors
          let sim=colorSimilarity(ref,cur);
          if(sim>0.7)correct+=sim;
        }
      }else if(!ref&&!cur){
        // Both empty = correct (don't count)
      }
    }
  }

  let accuracy=total>0?Math.round(correct/total*100):0;
  let stars=accuracy>=90?3:accuracy>=70?2:accuracy>=40?1:0;

  let popup=document.getElementById('score-popup');
  popup.innerHTML=`
    <h2>Challenge Complete!</h2>
    <div class="score-num">${accuracy}%</div>
    <div class="star">${'&#11088;'.repeat(stars)}${'&#9734;'.repeat(3-stars)}</div>
    <p>${accuracy>=90?'Perfect!':accuracy>=70?'Great work!':accuracy>=40?'Nice try!':'Keep practicing!'}</p>
    <button onclick="document.getElementById('score-popup').classList.add('hidden');showChallengeMenu()">Continue</button>
  `;
  popup.classList.remove('hidden');
  snd(accuracy>=70?800:400,0.2);
  if(accuracy>=70){snd(1000,0.15,'triangle')}
}

function colorSimilarity(c1,c2){
  let r1=parseInt(c1.slice(1,3),16)||0,g1=parseInt(c1.slice(3,5),16)||0,b1=parseInt(c1.slice(5,7),16)||0;
  // Handle rgb() format
  if(c2.startsWith('rgb')){
    let m=c2.match(/(\d+)/g);
    if(m){
      let r2=+m[0],g2=+m[1],b2=+m[2];
      let dist=Math.sqrt((r1-r2)**2+(g1-g2)**2+(b1-b2)**2);
      return Math.max(0,1-dist/441);
    }
  }
  let r2=parseInt(c2.slice(1,3),16)||0,g2=parseInt(c2.slice(3,5),16)||0,b2=parseInt(c2.slice(5,7),16)||0;
  let dist=Math.sqrt((r1-r2)**2+(g1-g2)**2+(b1-b2)**2);
  return Math.max(0,1-dist/441);
}

function startTimedDraw(){
  snd(500,0.1);
  challengeMode='timed-draw';
  challengePromptText=PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
  challengeTimer=30;

  gridSize=16;
  document.getElementById('size-display').textContent='16x16';
  initLayers();resize();

  let overlay=document.getElementById('challenge-overlay');
  overlay.innerHTML=`
    <h2>Timed Drawing</h2>
    <p>You have 30 seconds to draw:</p>
    <h2 style="color:#ffd93d;font-size:32px">${challengePromptText}</h2>
    <button onclick="beginTimedDraw()">Start!</button>
  `;
  overlay.classList.remove('hidden');
}

function beginTimedDraw(){
  document.getElementById('challenge-overlay').classList.add('hidden');
  let bar=document.getElementById('mode-bar');
  bar.className='challenge-mode';

  challengeTimerInterval=setInterval(()=>{
    challengeTimer--;
    bar.textContent=`Draw: ${challengePromptText} - ${challengeTimer}s remaining`;
    if(challengeTimer<=5)snd(600,0.05);
    if(challengeTimer<=0){
      clearInterval(challengeTimerInterval);
      // Auto-save
      saveToGallery();
      let popup=document.getElementById('score-popup');
      popup.innerHTML=`
        <h2>Time's Up!</h2>
        <p>Your drawing of "${challengePromptText}" has been saved to the gallery!</p>
        <button onclick="document.getElementById('score-popup').classList.add('hidden');showChallengeMenu()">Continue</button>
      `;
      popup.classList.remove('hidden');
      snd(400,0.2);
    }
  },1000);
  bar.textContent=`Draw: ${challengePromptText} - 30s remaining`;
}

function startDailyChallenge(){
  snd(500,0.1);
  challengeMode='daily';
  let day=Math.floor(Date.now()/86400000);
  let patternIdx=day%REF_PATTERNS.length;
  let pattern=REF_PATTERNS[patternIdx];

  // Build reference
  let refPixels=[];
  for(let y=0;y<pattern.size;y++){
    refPixels[y]=[];
    for(let x=0;x<pattern.size;x++){
      let v=pattern.data[y][x];
      refPixels[y][x]=v>0?pattern.colors[v-1]:null;
    }
  }
  challengeRef=refPixels;
  challengeMode='pixel-art';

  gridSize=pattern.size;
  document.getElementById('size-display').textContent=`${gridSize}x${gridSize}`;
  initLayers();resize();

  let refCanvas=document.createElement('canvas');
  refCanvas.width=pattern.size*20;refCanvas.height=pattern.size*20;
  let rx=refCanvas.getContext('2d');
  for(let y=0;y<pattern.size;y++){
    for(let x=0;x<pattern.size;x++){
      if(refPixels[y][x]){rx.fillStyle=refPixels[y][x];rx.fillRect(x*20,y*20,20,20)}
      else{rx.fillStyle=(x+y)%2===0?'#1a1a2e':'#1e1e3a';rx.fillRect(x*20,y*20,20,20)}
    }
  }

  // Check if already completed today
  let dailyBest=loadData('pp_daily_'+day);

  let overlay=document.getElementById('challenge-overlay');
  overlay.innerHTML=`
    <h2>Daily Challenge</h2>
    <p>Today's pattern: <b>${pattern.name}</b></p>
    <img class="ref-canvas" src="${refCanvas.toDataURL()}" width="160" height="160">
    ${dailyBest?`<p style="color:#ffd93d">Your best today: ${dailyBest}%</p>`:''}
    <button onclick="beginPixelChallenge()">Start!</button>
    <button class="sec" onclick="closeChallengeMenu()">Back</button>
  `;
  overlay.classList.remove('hidden');

  let bar=document.getElementById('mode-bar');
  bar.className='challenge-mode';
  bar.textContent='Daily Challenge: '+pattern.name;
}

// Layer management
function addLayer(){
  layers.unshift(makeLayer('Layer '+(layers.length+1)));
  activeLayerIdx=0;
  pushHistory();renderLayerPanel();
}
function deleteLayer(){
  if(layers.length<=1)return;
  layers.splice(activeLayerIdx,1);
  activeLayerIdx=Math.min(activeLayerIdx,layers.length-1);
  pushHistory();renderLayerPanel();
}
function moveLayer(dir){
  const ni=activeLayerIdx+dir;
  if(ni<0||ni>=layers.length)return;
  [layers[activeLayerIdx],layers[ni]]=[layers[ni],layers[activeLayerIdx]];
  activeLayerIdx=ni;
  pushHistory();renderLayerPanel();
}
function mergeDown(){
  if(activeLayerIdx>=layers.length-1)return;
  const src=layers[activeLayerIdx],dst=layers[activeLayerIdx+1];
  for(let y=0;y<gridSize;y++){
    for(let x=0;x<gridSize;x++){
      if(src.pixels[y]&&src.pixels[y][x])dst.pixels[y][x]=src.pixels[y][x];
    }
  }
  layers.splice(activeLayerIdx,1);
  pushHistory();renderLayerPanel();
}
function setActiveLayer(idx){activeLayerIdx=idx;renderLayerPanel()}
function toggleLayerVisibility(idx){
  layers[idx].visible=!layers[idx].visible;
  renderLayerPanel();
}
function setLayerOpacity(idx,val){layers[idx].opacity=val;renderLayerPanel()}

function renderLayerPanel(){
  const panel=document.getElementById('layer-panel');
  panel.innerHTML='';
  layers.forEach((l,i)=>{
    const row=document.createElement('div');
    row.className='layer-row'+(i===activeLayerIdx?' active':'');
    row.innerHTML=`<button class="vis-btn" data-i="${i}">${l.visible?'&#128065;':'&#128683;'}</button>`+
      `<span class="layer-name">${l.name}</span>`+
      `<input type="range" class="opacity-slider" min="0" max="100" value="${Math.round(l.opacity*100)}" data-i="${i}">`;
    row.addEventListener('click',e=>{
      if(e.target.tagName==='BUTTON'||e.target.tagName==='INPUT')return;
      setActiveLayer(i);
    });
    row.querySelector('.vis-btn').addEventListener('click',()=>toggleLayerVisibility(i));
    row.querySelector('.opacity-slider').addEventListener('input',e=>setLayerOpacity(i,e.target.value/100));
    panel.appendChild(row);
  });
}

// Hex color input
function updateColorUI(){
  document.getElementById('hex-input').value=currentColor;
  document.getElementById('hex-preview').style.background=currentColor;
  document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.swatch').forEach(s=>{
    if(s.style.backgroundColor&&rgbToHex(s.style.backgroundColor)===currentColor.toLowerCase())s.classList.add('active');
  });
}
function rgbToHex(rgb){
  if(rgb.startsWith('#'))return rgb.toLowerCase();
  const m=rgb.match(/\d+/g);
  if(!m||m.length<3)return rgb;
  return'#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join('');
}
document.getElementById('hex-input').addEventListener('input',e=>{
  let v=e.target.value.trim();
  if(!v.startsWith('#'))v='#'+v;
  if(/^#[0-9a-fA-F]{6}$/.test(v)){
    currentColor=v;
    document.getElementById('hex-preview').style.background=v;
    document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
    tool='draw';setTool('draw');
  }
});
document.getElementById('hex-input').addEventListener('keydown',e=>{if(e.key==='Enter')e.target.blur()});

// Build palette
let pal=document.getElementById('palette');
COLORS.forEach(c=>{
  let d=document.createElement('div');d.className='swatch';
  d.dataset.color=c;
  if(c===currentColor)d.classList.add('active');
  d.style.background=c;
  d.onclick=()=>{
    currentColor=c;tool='draw';setTool('draw');
    document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
    d.classList.add('active');
    updateColorUI();
    snd(400,0.03);
  };
  pal.appendChild(d);
});

// Custom color picker
let customInput=document.createElement('input');
customInput.type='color';customInput.id='custom-color';
customInput.value='#ff00ff';
customInput.oninput=()=>{
  currentColor=customInput.value;tool='draw';setTool('draw');
  document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('active'));
};
pal.appendChild(customInput);

// Daily prompt
let day=Math.floor(Date.now()/86400000);
document.getElementById('daily-prompt').textContent=PROMPTS[day%PROMPTS.length];

// Tutorial on first visit
function closeTutorial(){
  document.getElementById('tutorial').classList.add('hidden');
  saveData('pp_tutorial_done',true);
}
if(!loadData('pp_tutorial_done')){
  document.getElementById('tutorial').classList.remove('hidden');
}

initLayers();
window.addEventListener('resize',resize);
resize();
render();
updateColorUI();
</script>
</body>
</html>
