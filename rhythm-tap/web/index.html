<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Rhythm Tap</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0014;font-family:-apple-system,system-ui,sans-serif;touch-action:none;user-select:none}
canvas{display:block}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(10,0,20,0.95);z-index:20}
.overlay h1{font-size:clamp(2.5rem,8vw,4rem);font-weight:900;background:linear-gradient(135deg,#ff006e,#8338ec,#3a86ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.overlay .sub{color:#888;margin-bottom:24px}
.btn{background:linear-gradient(135deg,#ff006e,#8338ec);border:none;color:#fff;font-weight:800;font-size:1rem;padding:14px 36px;border-radius:50px;cursor:pointer;margin:6px;letter-spacing:1px}
.btn:active{transform:scale(0.95)}
.btn.sec{background:rgba(255,255,255,0.1)}
.diff-btns{display:flex;gap:8px;margin:16px 0}
.diff-btn{padding:10px 20px;border-radius:12px;border:2px solid rgba(255,255,255,0.1);background:none;color:#fff;font-weight:700;cursor:pointer;font-size:0.85rem}
.diff-btn.active{border-color:#ff006e;background:rgba(255,0,110,0.15)}
.final-score{font-size:2.5rem;font-weight:900;color:#ff006e;margin:8px 0;text-shadow:0 0 20px rgba(255,0,110,0.5)}
.stats{color:#aaa;font-size:0.85rem;margin:4px 0}
.hidden{display:none!important}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="overlay" id="menu">
  <h1>RHYTHM TAP</h1>
  <div class="sub">Tap the notes as they cross the line</div>
  <div style="color:#666;font-size:0.8rem;margin-bottom:4px">Difficulty</div>
  <div class="diff-btns">
    <button class="diff-btn" data-diff="easy">Easy<br><span style="font-size:0.7rem;color:#888">2 lanes</span></button>
    <button class="diff-btn active" data-diff="normal">Normal<br><span style="font-size:0.7rem;color:#888">3 lanes</span></button>
    <button class="diff-btn" data-diff="hard">Hard<br><span style="font-size:0.7rem;color:#888">4 lanes</span></button>
  </div>
  <button class="btn" id="start-btn">PLAY</button>
</div>

<div class="overlay hidden" id="results">
  <div style="color:#888;font-size:0.9rem">SONG COMPLETE</div>
  <div class="final-score" id="r-score">0</div>
  <div class="stats" id="r-combo">Max Combo: 0</div>
  <div class="stats" id="r-acc">Perfect: 0 | Good: 0 | Miss: 0</div>
  <div class="stats" id="r-best"></div>
  <button class="btn" id="retry-btn">RETRY</button>
  <button class="btn sec" onclick="document.getElementById('results').classList.add('hidden');document.getElementById('menu').classList.remove('hidden')">MENU</button>
</div>

<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight}
window.addEventListener('resize',resize);resize();

let audioCtx,difficulty='normal';
const CONFIGS={easy:{lanes:2,bpm:100,noteInterval:600},normal:{lanes:3,bpm:120,noteInterval:450},hard:{lanes:4,bpm:140,noteInterval:350}};
const LANE_COLORS=['#ff006e','#8338ec','#3a86ff','#ff9500'];
const HIT_LINE_Y_PCT=0.82;
const NOTE_SPEED_PCT=0.0012; // per ms, fraction of screen height

let notes,score,combo,maxCombo,perfects,goods,misses,particles;
let songTime,lastNoteTime,gameActive,notePattern;
let hitEffects=[];

function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)()}

function playNote(freq,dur=0.12,type='square',vol=0.08){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type=type;o.frequency.value=freq;g.gain.setValueAtTime(vol,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur);
}

function playBeat(){
  if(!audioCtx)return;
  const t=audioCtx.currentTime;
  // Kick
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(30,t+0.1);
  g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);
  o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+0.15);
}

function playHit(quality){
  if(quality==='perfect')playNote(880,0.08,'sine',0.1);
  else if(quality==='good')playNote(660,0.06,'sine',0.07);
}

function playMiss(){playNote(200,0.15,'sawtooth',0.05)}

// Generate a rhythmic pattern
function generatePattern(cfg){
  const pattern=[];
  const duration=30000; // 30 second song
  const beatMs=60000/cfg.bpm;
  let t=2000; // 2s lead-in
  while(t<duration){
    // On beat: usually spawn a note
    if(Math.random()<0.75){
      const lane=Math.floor(Math.random()*cfg.lanes);
      pattern.push({time:t,lane});
    }
    // Sometimes double notes on harder difficulties
    if(cfg.lanes>=3&&Math.random()<0.2){
      let lane2=Math.floor(Math.random()*cfg.lanes);
      pattern.push({time:t,lane:lane2});
    }
    // Half-beat notes for variety
    if(Math.random()<0.3){
      const lane=Math.floor(Math.random()*cfg.lanes);
      pattern.push({time:t+beatMs/2,lane});
    }
    t+=beatMs;
  }
  return{pattern,duration};
}

document.querySelectorAll('.diff-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.diff-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');difficulty=b.dataset.diff;
  });
});

document.getElementById('start-btn').addEventListener('click',startGame);
document.getElementById('retry-btn').addEventListener('click',startGame);

function startGame(){
  initAudio();
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('results').classList.add('hidden');
  
  const cfg=CONFIGS[difficulty];
  const song=generatePattern(cfg);
  notePattern=song;
  
  notes=[];score=0;combo=0;maxCombo=0;perfects=0;goods=0;misses=0;particles=[];hitEffects=[];
  songTime=0;lastNoteTime=0;gameActive=true;
  
  // Spawn notes as they come
  let patIdx=0;
  const hitLineY=H*HIT_LINE_Y_PCT;
  const travelTime=hitLineY/(NOTE_SPEED_PCT*H*1000)*1000; // ms to travel from top to hit line
  
  let lastFrame=performance.now();
  let beatTimer=0;
  const beatMs=60000/cfg.bpm;
  
  function gameLoop(now){
    if(!gameActive)return;
    const dt=now-lastFrame;lastFrame=now;
    songTime+=dt;
    beatTimer+=dt;
    
    // Beat pulse
    if(beatTimer>=beatMs){beatTimer-=beatMs;playBeat()}
    
    // Spawn notes that should appear
    while(patIdx<song.pattern.length){
      const n=song.pattern[patIdx];
      if(n.time-travelTime<=songTime){
        notes.push({lane:n.lane,targetTime:n.time,y:-20,hit:false,missed:false});
        patIdx++;
      }else break;
    }
    
    // Update notes
    const hitY=hitLineY;
    for(let i=notes.length-1;i>=0;i--){
      const n=notes[i];
      const progress=(songTime-(n.targetTime-travelTime))/travelTime;
      n.y=progress*hitY;
      
      // Miss check
      if(!n.hit&&n.y>hitY+60){
        n.missed=true;combo=0;misses++;
        notes.splice(i,1);
      }
      // Remove old hit notes
      if(n.hit&&n.y>H+50)notes.splice(i,1);
    }
    
    // Song end
    if(songTime>=song.duration+2000){
      gameActive=false;showResults();return;
    }
    
    draw(cfg,hitLineY,beatTimer/beatMs);
    requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);
}

function tryHit(laneIdx){
  if(!gameActive)return;
  const hitY=H*HIT_LINE_Y_PCT;
  let closest=null,closestDist=Infinity;
  
  for(const n of notes){
    if(n.hit||n.lane!==laneIdx)continue;
    const dist=Math.abs(n.y-hitY);
    if(dist<closestDist){closestDist=dist;closest=n}
  }
  
  if(!closest||closestDist>80)return;
  
  closest.hit=true;
  let quality;
  if(closestDist<20){quality='perfect';score+=100*(1+combo*0.1);perfects++;playHit('perfect')}
  else if(closestDist<50){quality='good';score+=50*(1+combo*0.05);goods++;playHit('good')}
  else{quality='good';score+=25;goods++;playHit('good')}
  
  combo++;if(combo>maxCombo)maxCombo=combo;
  
  // Particles
  const cfg=CONFIGS[difficulty];
  const laneW=W/cfg.lanes;
  const cx=laneIdx*laneW+laneW/2;
  for(let i=0;i<12;i++){
    const a=Math.random()*Math.PI*2,sp=2+Math.random()*4;
    particles.push({x:cx,y:H*HIT_LINE_Y_PCT,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,color:LANE_COLORS[laneIdx],size:3+Math.random()*3});
  }
  hitEffects.push({lane:laneIdx,quality,time:1,y:H*HIT_LINE_Y_PCT});
}

// Touch controls
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const cfg=CONFIGS[difficulty];
  const laneW=W/cfg.lanes;
  for(const t of e.changedTouches){
    const lane=Math.floor(t.clientX/laneW);
    if(lane>=0&&lane<cfg.lanes)tryHit(lane);
  }
},{passive:false});

// Keyboard
document.addEventListener('keydown',e=>{
  const map={d:0,f:1,j:2,k:3};
  if(map[e.key]!==undefined)tryHit(map[e.key]);
});

function draw(cfg,hitLineY,beatPhase){
  ctx.fillStyle='rgba(10,0,20,0.4)';ctx.fillRect(0,0,W,H);
  
  const lanes=cfg.lanes;
  const laneW=W/lanes;
  
  // Lane dividers
  ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=1;
  for(let i=1;i<lanes;i++){ctx.beginPath();ctx.moveTo(i*laneW,0);ctx.lineTo(i*laneW,H);ctx.stroke()}
  
  // Hit line with beat pulse
  const pulse=Math.max(0,1-beatPhase*3)*0.3;
  ctx.strokeStyle=`rgba(255,255,255,${0.3+pulse})`;ctx.lineWidth=2+pulse*4;
  ctx.beginPath();ctx.moveTo(0,hitLineY);ctx.lineTo(W,hitLineY);ctx.stroke();
  
  // Lane indicators at bottom
  for(let i=0;i<lanes;i++){
    ctx.fillStyle=LANE_COLORS[i]+'20';
    ctx.fillRect(i*laneW,hitLineY-30,laneW,60);
  }
  
  // Notes
  for(const n of notes){
    if(n.hit)continue;
    const cx=n.lane*laneW+laneW/2;
    const color=LANE_COLORS[n.lane];
    const noteW=laneW*0.6;
    const noteH=18;
    
    ctx.save();
    ctx.shadowBlur=15;ctx.shadowColor=color;
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.roundRect(cx-noteW/2,n.y-noteH/2,noteW,noteH,noteH/2);
    ctx.fill();
    ctx.shadowBlur=0;
    // Inner glow
    ctx.fillStyle='rgba(255,255,255,0.3)';
    ctx.beginPath();
    ctx.roundRect(cx-noteW/2+4,n.y-noteH/2+3,noteW-8,noteH/2-2,4);
    ctx.fill();
    ctx.restore();
  }
  
  // Hit effects
  for(let i=hitEffects.length-1;i>=0;i--){
    const e=hitEffects[i];
    e.time-=0.03;
    if(e.time<=0){hitEffects.splice(i,1);continue}
    const cx=e.lane*laneW+laneW/2;
    ctx.globalAlpha=e.time;
    ctx.fillStyle=e.quality==='perfect'?'#ffd700':'#fff';
    ctx.font=`bold ${16+10*(1-e.time)}px sans-serif`;
    ctx.textAlign='center';
    ctx.fillText(e.quality==='perfect'?'PERFECT':'GOOD',cx,e.y-20-30*(1-e.time));
    ctx.globalAlpha=1;
  }
  
  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life-=0.025;
    if(p.life<=0){particles.splice(i,1);continue}
    ctx.globalAlpha=p.life;ctx.fillStyle=p.color;
    ctx.shadowBlur=4;ctx.shadowColor=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.globalAlpha=1;
  }
  
  // HUD
  ctx.fillStyle='#fff';ctx.font='bold 1.2rem sans-serif';ctx.textAlign='left';
  ctx.fillText(Math.round(score),16,32);
  
  if(combo>1){
    ctx.fillStyle='#ffd700';ctx.font='bold 1rem sans-serif';ctx.textAlign='center';
    ctx.fillText(`${combo}x COMBO`,W/2,32);
  }
  
  // Progress bar
  const prog=Math.min(songTime/(notePattern.duration),1);
  ctx.fillStyle='rgba(255,255,255,0.1)';ctx.fillRect(0,H-4,W,4);
  ctx.fillStyle='linear-gradient(90deg,#ff006e,#3a86ff)';
  ctx.fillStyle='#ff006e';ctx.fillRect(0,H-4,W*prog,4);
}

function showResults(){
  score=Math.round(score);
  document.getElementById('r-score').textContent=score;
  document.getElementById('r-combo').textContent=`Max Combo: ${maxCombo}x`;
  document.getElementById('r-acc').textContent=`Perfect: ${perfects} | Good: ${goods} | Miss: ${misses}`;
  
  const key=`rhythmtap_${difficulty}`;
  const best=parseInt(localStorage.getItem(key))||0;
  if(score>best)localStorage.setItem(key,score);
  document.getElementById('r-best').textContent=score>best?'ðŸŽ‰ NEW HIGH SCORE!':`Best: ${Math.max(best,score)}`;
  
  document.getElementById('results').classList.remove('hidden');
}

// Initial draw
ctx.fillStyle='#0a0014';ctx.fillRect(0,0,W,H);
</script>
</body>
</html>
